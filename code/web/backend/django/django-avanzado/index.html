<!doctype html><html lang=es class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Apuntes de fácil acceso para distintas tecnologías."><link href=https://crisconru.github.io/code/web/backend/django/django-avanzado/ rel=canonical><meta name=author content="Cristóbal Contreras Rubio"><meta name=lang:clipboard.copy content="Copiar al portapapeles"><meta name=lang:clipboard.copied content="Copiado al portapapeles"><meta name=lang:search.language content=es><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No se encontraron documentos"><meta name=lang:search.result.one content="1 documento encontrado"><meta name=lang:search.result.other content="# documentos encontrados"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.0"><title>Avanzado - Tips de Cristo</title><link rel=stylesheet href=../../../../../assets/stylesheets/application.0284f74d.css><link rel=stylesheet href=../../../../../assets/stylesheets/application-palette.01803549.css><meta name=theme-color content=#4caf50><script src=../../../../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=green data-md-color-accent=pink> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#django-avanzado tabindex=1 class=md-skip> Saltar a contenido </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://crisconru.github.io/ title="Tips de Cristo" class="md-header-nav__button md-logo"> <i class=md-icon></i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Tips de Cristo </span> <span class=md-header-nav__topic> Avanzado </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Búsqueda autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Teclee para comenzar búsqueda </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/crisconru/tips title="Ir al repositorio" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> crisconru/tips </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://crisconru.github.io/ title="Tips de Cristo" class="md-nav__button md-logo"> <i class=md-icon></i> </a> Tips de Cristo </label> <div class=md-nav__source> <a href=https://github.com/crisconru/tips title="Ir al repositorio" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> crisconru/tips </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../.. title=Contenido class=md-nav__link> Contenido </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Code </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Code </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> Devops </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1-1 type=checkbox id=nav-2-1-1> <label class=md-nav__link for=nav-2-1-1> Ansible </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-1-1> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/ansible/ansible/ title=Ansible class=md-nav__link> Ansible </a> </li> <li class=md-nav__item> <a href=../../../../devops/ansible/inventario/ title=Inventario class=md-nav__link> Inventario </a> </li> <li class=md-nav__item> <a href=../../../../devops/ansible/comandos/ title=Comandos class=md-nav__link> Comandos </a> </li> <li class=md-nav__item> <a href=../../../../devops/ansible/configuracion/ title=Configuracion class=md-nav__link> Configuracion </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1-1-5 type=checkbox id=nav-2-1-1-5> <label class=md-nav__link for=nav-2-1-1-5> Playbooks </label> <nav class=md-nav data-md-component=collapsible data-md-level=4> <label class=md-nav__title for=nav-2-1-1-5> Playbooks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/ansible/playbook/playbook/ title=Playbook class=md-nav__link> Playbook </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1-2 type=checkbox id=nav-2-1-2> <label class=md-nav__link for=nav-2-1-2> Docker </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-1-2> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/docker/docker-aclaraciones/ title=Aclaraciones class=md-nav__link> Aclaraciones </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-instalacion/ title=Instalación class=md-nav__link> Instalación </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-hub/ title="Docker Hub" class=md-nav__link> Docker Hub </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-comandos/ title="Comandos docker" class=md-nav__link> Comandos docker </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-contenedores/ title="Lanzar contenedores" class=md-nav__link> Lanzar contenedores </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-imagenes/ title="Crear imágenes" class=md-nav__link> Crear imágenes </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-dockerfile/ title=Dockerfile class=md-nav__link> Dockerfile </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-volumes/ title=Volumes class=md-nav__link> Volumes </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-network/ title=Network class=md-nav__link> Network </a> </li> <li class=md-nav__item> <a href=../../../../devops/docker/docker-dockercompose/ title="Docker Compose" class=md-nav__link> Docker Compose </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1-3 type=checkbox id=nav-2-1-3> <label class=md-nav__link for=nav-2-1-3> ELK </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-1-3> ELK </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/elk/elk/ title=ELK class=md-nav__link> ELK </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../devops/git/git-git/ title=Git class=md-nav__link> Git </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1-5 type=checkbox id=nav-2-1-5> <label class=md-nav__link for=nav-2-1-5> Git Flow </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-1-5> Git Flow </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/git/gitflow/gitflow-gitflow/ title="Git Flow" class=md-nav__link> Git Flow </a> </li> <li class=md-nav__item> <a href=../../../../devops/git/gitflow/gitflow-instalacion/ title="Puesta a punto" class=md-nav__link> Puesta a punto </a> </li> <li class=md-nav__item> <a href=../../../../devops/git/gitflow/gitflow-comandos/ title=Comandos class=md-nav__link> Comandos </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> IDEs </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> IDEs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../ides/vscode/vscode/ title="Visual Studio code" class=md-nav__link> Visual Studio code </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Python </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3-1 type=checkbox id=nav-2-3-1> <label class=md-nav__link for=nav-2-3-1> Entornos virtuales </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-3-1> Entornos virtuales </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/venv/venv-introduccion/ title=Introducción class=md-nav__link> Introducción </a> </li> <li class=md-nav__item> <a href=../../../../python/venv/venv-virtualenv/ title=virtualenv class=md-nav__link> virtualenv </a> </li> <li class=md-nav__item> <a href=../../../../python/venv/venv-virtualenvwrapper/ title=virtualenvwrapper class=md-nav__link> virtualenvwrapper </a> </li> <li class=md-nav__item> <a href=../../../../python/venv/venv-pipenv/ title=pipenv class=md-nav__link> pipenv </a> </li> <li class=md-nav__item> <a href=../../../../python/venv/venv-pyenv/ title=pyenv class=md-nav__link> pyenv </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../python/python-pythonpath/ title=PYTHONPATH class=md-nav__link> PYTHONPATH </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4 checked> <label class=md-nav__link for=nav-2-4> Web </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> Web </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1 type=checkbox id=nav-2-4-1> <label class=md-nav__link for=nav-2-4-1> Frontend </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-1> Frontend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../frontend/html/html-indice/ title=HTML class=md-nav__link> HTML </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-1-2 type=checkbox id=nav-2-4-1-2> <label class=md-nav__link for=nav-2-4-1-2> CSS </label> <nav class=md-nav data-md-component=collapsible data-md-level=4> <label class=md-nav__title for=nav-2-4-1-2> CSS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../frontend/css/css-plugins/ title=Plugins class=md-nav__link> Plugins </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../frontend/js/js-indice/ title=JS class=md-nav__link> JS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-2 type=checkbox id=nav-2-4-2 checked> <label class=md-nav__link for=nav-2-4-2> Backend </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-4-2> Backend </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4-2-1 type=checkbox id=nav-2-4-2-1 checked> <label class=md-nav__link for=nav-2-4-2-1> Django </label> <nav class=md-nav data-md-component=collapsible data-md-level=4> <label class=md-nav__title for=nav-2-4-2-1> Django </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../django/ title=Django class=md-nav__link> Django </a> </li> <li class=md-nav__item> <a href=../django-principiante/ title=Principiante class=md-nav__link> Principiante </a> </li> <li class=md-nav__item> <a href=../django-intermedio/ title=Intermedio class=md-nav__link> Intermedio </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Avanzado </label> <a href=./ title=Avanzado class="md-nav__link md-nav__link--active"> Avanzado </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Tabla de contenidos</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#incluir-una-plantilla-html-en-todas-las-plantillas-de-la-app title="Incluir una plantilla html en todas las plantillas de la app" class=md-nav__link> Incluir una plantilla html en todas las plantillas de la app </a> </li> <li class=md-nav__item> <a href=#definir-estructuras-en-los-urlspattern title="Definir estructuras en los urlspattern" class=md-nav__link> Definir estructuras en los urlspattern </a> </li> <li class=md-nav__item> <a href=#vistas-basadas-en-clases title="Vistas Basadas en Clases" class=md-nav__link> Vistas Basadas en Clases </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#listview title=ListView class=md-nav__link> ListView </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#paginacion title=Paginación class=md-nav__link> Paginación </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#detailview title=DetailView class=md-nav__link> DetailView </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#vistas-crud title="Vistas CRUD" class=md-nav__link> Vistas CRUD </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#createview-vista-crud title="CreateView - Vista CRUD" class=md-nav__link> CreateView - Vista CRUD </a> </li> <li class=md-nav__item> <a href=#updateview-vista-crud title="UpdateView - Vista CRUD" class=md-nav__link> UpdateView - Vista CRUD </a> </li> <li class=md-nav__item> <a href=#deleteview-vista-crud title="DeleteView - Vista CRUD" class=md-nav__link> DeleteView - Vista CRUD </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#formularios-para-modelos title="Formularios para Modelos" class=md-nav__link> Formularios para Modelos </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ckeditor-adaptativo title="ckeditor adaptativo" class=md-nav__link> ckeditor adaptativo </a> </li> <li class=md-nav__item> <a href=#usuarios-registrados title="Usuarios registrados" class=md-nav__link> Usuarios registrados </a> </li> <li class=md-nav__item> <a href=#usuarios-registrados-mixins-manual title="Usuarios registrados - Mixins Manual" class=md-nav__link> Usuarios registrados - Mixins Manual </a> </li> <li class=md-nav__item> <a href=#usuarios-registrados-mixins-decorado title="Usuarios registrados - Mixins Decorado" class=md-nav__link> Usuarios registrados - Mixins Decorado </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#auth-views title="Auth Views" class=md-nav__link> Auth Views </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#loginview title=LoginView class=md-nav__link> LoginView </a> </li> <li class=md-nav__item> <a href=#logoutview title=LogoutView class=md-nav__link> LogoutView </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#registro-de-usuario title="Registro de Usuario" class=md-nav__link> Registro de Usuario </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#customizar-el-registro title="Customizar el registro" class=md-nav__link> Customizar el registro </a> </li> <li class=md-nav__item> <a href=#anadir-email-como-requisito title="Añadir email como requisito" class=md-nav__link> Añadir email como requisito </a> </li> <li class=md-nav__item> <a href=#recuperar-contrasena title="Recuperar contraseña" class=md-nav__link> Recuperar contraseña </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#perfil-de-usuario title="Perfil de Usuario" class=md-nav__link> Perfil de Usuario </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#crear-perfil title="Crear perfil" class=md-nav__link> Crear perfil </a> </li> <li class=md-nav__item> <a href=#perfil-editable title="Perfil editable" class=md-nav__link> Perfil editable </a> </li> <li class=md-nav__item> <a href=#customizando-formulario-de-perfil title="Customizando formulario de Perfil" class=md-nav__link> Customizando formulario de Perfil </a> </li> <li class=md-nav__item> <a href=#email-editable title="Email editable" class=md-nav__link> Email editable </a> </li> <li class=md-nav__item> <a href=#contrasena-editable title="Contraseña Editable" class=md-nav__link> Contraseña Editable </a> </li> <li class=md-nav__item> <a href=#optimizar-guardado-de-avatar title="Optimizar guardado de avatar" class=md-nav__link> Optimizar guardado de avatar </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#senales title=Señales class=md-nav__link> Señales </a> </li> <li class=md-nav__item> <a href=#tdd title=TDD class=md-nav__link> TDD </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tests-simples title="Tests Simples" class=md-nav__link> Tests Simples </a> </li> <li class=md-nav__item> <a href=#ejemplo-de-test-con-senales title="Ejemplo de Test con señales" class=md-nav__link> Ejemplo de Test con señales </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#model-manager title="Model Manager" class=md-nav__link> Model Manager </a> </li> <li class=md-nav__item> <a href=#js-peticiones-asincronas title="JS - Peticiones asíncronas" class=md-nav__link> JS - Peticiones asíncronas </a> </li> <li class=md-nav__item> <a href=#deploy title=Deploy class=md-nav__link> Deploy </a> </li> <li class=md-nav__item> <a href=#customizar-el-admin title="Customizar el Admin" class=md-nav__link> Customizar el Admin </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Software </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Software </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1> <label class=md-nav__link for=nav-3-1> Linux </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-1> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../sw/linux/linux-fecha-hora/ title="Fecha y Hora" class=md-nav__link> Fecha y Hora </a> </li> <li class=md-nav__item> <a href=../../../../../sw/linux/linux-ficheros/ title=Ficheros class=md-nav__link> Ficheros </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Redes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-2> Redes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../sw/redes/redes-linux/ title=Linux class=md-nav__link> Linux </a> </li> <li class=md-nav__item> <a href=../../../../../sw/redes/redes-ssh/ title=SSH class=md-nav__link> SSH </a> </li> <li class=md-nav__item> <a href=../../../../../sw/redes/redes-iptables/ title=iptables class=md-nav__link> iptables </a> </li> <li class=md-nav__item> <a href=../../../../../sw/redes/redes-ipv6/ title=IPv6 class=md-nav__link> IPv6 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Terminal </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-3> Terminal </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../sw/terminal/terminal-bash/ title=Bash class=md-nav__link> Bash </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-3-2 type=checkbox id=nav-3-3-2> <label class=md-nav__link for=nav-3-3-2> tmux </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-3-3-2> tmux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../sw/terminal/tmux/tmux-comandos/ title=Comandos class=md-nav__link> Comandos </a> </li> <li class=md-nav__item> <a href=../../../../../sw/terminal/tmux/tmux-customizar/ title=Customización class=md-nav__link> Customización </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../sw/terminal/terminal-zsh/ title=ZSH class=md-nav__link> ZSH </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Hardware </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Hardware </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../hw/upython/upython-informacion/ title=Micropython class=md-nav__link> Micropython </a> </li> <li class=md-nav__item> <a href=../../../../../hw/pio/pio-informacion/ title=Platformio class=md-nav__link> Platformio </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> IoT </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> IoT </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> MQTT </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> MQTT </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../iot/mqtt/mqtt/ title=MQTT class=md-nav__link> MQTT </a> </li> <li class=md-nav__item> <a href=../../../../../iot/mqtt/mqtt-hello-world/ title="Hola mundo" class=md-nav__link> Hola mundo </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Tabla de contenidos</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#incluir-una-plantilla-html-en-todas-las-plantillas-de-la-app title="Incluir una plantilla html en todas las plantillas de la app" class=md-nav__link> Incluir una plantilla html en todas las plantillas de la app </a> </li> <li class=md-nav__item> <a href=#definir-estructuras-en-los-urlspattern title="Definir estructuras en los urlspattern" class=md-nav__link> Definir estructuras en los urlspattern </a> </li> <li class=md-nav__item> <a href=#vistas-basadas-en-clases title="Vistas Basadas en Clases" class=md-nav__link> Vistas Basadas en Clases </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#listview title=ListView class=md-nav__link> ListView </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#paginacion title=Paginación class=md-nav__link> Paginación </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#detailview title=DetailView class=md-nav__link> DetailView </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#vistas-crud title="Vistas CRUD" class=md-nav__link> Vistas CRUD </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#createview-vista-crud title="CreateView - Vista CRUD" class=md-nav__link> CreateView - Vista CRUD </a> </li> <li class=md-nav__item> <a href=#updateview-vista-crud title="UpdateView - Vista CRUD" class=md-nav__link> UpdateView - Vista CRUD </a> </li> <li class=md-nav__item> <a href=#deleteview-vista-crud title="DeleteView - Vista CRUD" class=md-nav__link> DeleteView - Vista CRUD </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#formularios-para-modelos title="Formularios para Modelos" class=md-nav__link> Formularios para Modelos </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ckeditor-adaptativo title="ckeditor adaptativo" class=md-nav__link> ckeditor adaptativo </a> </li> <li class=md-nav__item> <a href=#usuarios-registrados title="Usuarios registrados" class=md-nav__link> Usuarios registrados </a> </li> <li class=md-nav__item> <a href=#usuarios-registrados-mixins-manual title="Usuarios registrados - Mixins Manual" class=md-nav__link> Usuarios registrados - Mixins Manual </a> </li> <li class=md-nav__item> <a href=#usuarios-registrados-mixins-decorado title="Usuarios registrados - Mixins Decorado" class=md-nav__link> Usuarios registrados - Mixins Decorado </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#auth-views title="Auth Views" class=md-nav__link> Auth Views </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#loginview title=LoginView class=md-nav__link> LoginView </a> </li> <li class=md-nav__item> <a href=#logoutview title=LogoutView class=md-nav__link> LogoutView </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#registro-de-usuario title="Registro de Usuario" class=md-nav__link> Registro de Usuario </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#customizar-el-registro title="Customizar el registro" class=md-nav__link> Customizar el registro </a> </li> <li class=md-nav__item> <a href=#anadir-email-como-requisito title="Añadir email como requisito" class=md-nav__link> Añadir email como requisito </a> </li> <li class=md-nav__item> <a href=#recuperar-contrasena title="Recuperar contraseña" class=md-nav__link> Recuperar contraseña </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#perfil-de-usuario title="Perfil de Usuario" class=md-nav__link> Perfil de Usuario </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#crear-perfil title="Crear perfil" class=md-nav__link> Crear perfil </a> </li> <li class=md-nav__item> <a href=#perfil-editable title="Perfil editable" class=md-nav__link> Perfil editable </a> </li> <li class=md-nav__item> <a href=#customizando-formulario-de-perfil title="Customizando formulario de Perfil" class=md-nav__link> Customizando formulario de Perfil </a> </li> <li class=md-nav__item> <a href=#email-editable title="Email editable" class=md-nav__link> Email editable </a> </li> <li class=md-nav__item> <a href=#contrasena-editable title="Contraseña Editable" class=md-nav__link> Contraseña Editable </a> </li> <li class=md-nav__item> <a href=#optimizar-guardado-de-avatar title="Optimizar guardado de avatar" class=md-nav__link> Optimizar guardado de avatar </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#senales title=Señales class=md-nav__link> Señales </a> </li> <li class=md-nav__item> <a href=#tdd title=TDD class=md-nav__link> TDD </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tests-simples title="Tests Simples" class=md-nav__link> Tests Simples </a> </li> <li class=md-nav__item> <a href=#ejemplo-de-test-con-senales title="Ejemplo de Test con señales" class=md-nav__link> Ejemplo de Test con señales </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#model-manager title="Model Manager" class=md-nav__link> Model Manager </a> </li> <li class=md-nav__item> <a href=#js-peticiones-asincronas title="JS - Peticiones asíncronas" class=md-nav__link> JS - Peticiones asíncronas </a> </li> <li class=md-nav__item> <a href=#deploy title=Deploy class=md-nav__link> Deploy </a> </li> <li class=md-nav__item> <a href=#customizar-el-admin title="Customizar el Admin" class=md-nav__link> Customizar el Admin </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1 id=django-avanzado>Django Avanzado<a class=headerlink href=#django-avanzado title="Permanent link">&para;</a></h1> <h2 id=incluir-una-plantilla-html-en-todas-las-plantillas-de-la-app>Incluir una plantilla html en todas las plantillas de la app<a class=headerlink href=#incluir-una-plantilla-html-en-todas-las-plantillas-de-la-app title="Permanent link">&para;</a></h2> <p>Si quieres que en todas las plantillas de la app aparezca cierto código html común, debes de:</p> <ol> <li>Crear el directorio <code class=codehilite><span class=o>&lt;</span><span class=n>proyecto</span><span class=o>&gt;/&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/</span><span class=n>includes</span></code>.</li> <li>Dentro de <code class=codehilite><span class=n>includes</span></code> crear tu plantilla html común para los demás.</li> <li>En cada plantilla html de tu app, en el dentro de tu <code class=codehilite><span class=cp>{%</span> <span class=k>block</span> <span class=nv>content</span> <span class=cp>%}</span><span class=x></span></code>, añadirla con <code class=codehilite>{<span class=o>%</span> <span class=k>include</span> <span class=s1>&#39;</span><span class=s>&lt;app&gt;/includes/&lt;template&gt;.html</span><span class=s1>&#39;</span> <span class=o>%</span>}</code></li> </ol> <h2 id=definir-estructuras-en-los-urlspattern>Definir estructuras en los urlspattern<a class=headerlink href=#definir-estructuras-en-los-urlspattern title="Permanent link">&para;</a></h2> <p>Suponte que tienes varias apps, donde hay una vista que se llama igual, por ejemplo <code class=codehilite><span class=k>create</span></code>. En el <code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> le tienes puesto <code class=codehilite><span class=n>name</span><span class=o>=&lt;</span><span class=n>app</span><span class=o>&gt;</span><span class=n>_create</span></code> para que no coincidan. Para no tener que hacer eso, se puede usar una reestructura de los urlpatterns.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Le pones el nombre que quieras al <code class=codehilite><span class=n>urlpatterns</span></code>, pero ahora en vez de ser una lista como antes, va a ser una tupla, que tiene en su primer miembro el <code class=codehilite><span class=n>urlpatterns</span></code>, y en el segundo un nombre de referencia. Ahora puedes asignar nombres genéricos en el <code class=codehilite><span class=n>urlpatterns</span></code>, como es el caso de <code class=codehilite><span class=k>create</span></code> que lo vas a usar en más <code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> de otras apps.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>PageListView</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=p>,</span> <span class=n>PageCreate</span>

<span class=n>pages_patterns</span> <span class=o>=</span> <span class=p>([</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>PageListView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;pages&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&lt;int:pk&gt;/&lt;slug:slug&gt;/&#39;</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;page&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;create/&#39;</span><span class=p>,</span> <span class=n>PageCreate</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;create&#39;</span><span class=p>),</span>
<span class=p>],</span> <span class=s1>&#39;pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>proyecto</span><span class=o>&gt;/&lt;</span><span class=n>proyecto</span><span class=o>&gt;/</span><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importa tu <code class=codehilite><span class=n>urlpatterns</span></code> tuneado (en este caso <code class=codehilite><span class=n>pages_urlpatterns</span></code>), y lo incluyes directamente en la función <code class=codehilite><span class=k>include</span><span class=ss>()</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.contrib</span> <span class=kn>import</span> <span class=n>admin</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span><span class=p>,</span> <span class=n>include</span>
<span class=kn>from</span> <span class=nn>pages.urls</span> <span class=kn>import</span> <span class=n>pages_patterns</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;core.urls&#39;</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;pages/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=n>pages_patterns</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;admin/&#39;</span><span class=p>,</span> <span class=n>admin</span><span class=o>.</span><span class=n>site</span><span class=o>.</span><span class=n>urls</span><span class=p>),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=p>..</span><span class=o>&gt;/</span><span class=k>template</span><span class=o>/&lt;</span><span class=p>..</span><span class=o>&gt;</span></code> -&gt; Lo único que te falta es que ahora, en todas las templates que lo enlazas con <code class=codehilite><span class=err>{</span><span class=o>%</span> <span class=n>urls</span> <span class=s1>&#39;&lt;vista&gt;&#39;</span> <span class=p>...</span> <span class=o>%</span><span class=err>}</span></code> debes de poner <code class=codehilite><span class=err>{</span><span class=o>%</span> <span class=n>urls</span> <span class=s1>&#39;&lt;urls de donde vengo&gt;:&lt;vista&gt;&#39;</span> <span class=p>...</span> <span class=o>%</span><span class=err>}</span></code>. En este ejemplo sería:</p> <ol> <li><code class=codehilite><span class=err>{</span><span class=o>%</span> <span class=n>urls</span> <span class=s1>&#39;pages:pages&#39;</span> <span class=p>...</span> <span class=o>%</span><span class=err>}</span></code> Cuando es un template fuera de la app, que enlaza desde el <code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> del proyecto a la app.</li> <li><code class=codehilite><span class=err>{</span><span class=o>%</span> <span class=n>urls</span> <span class=s1>&#39;pages:create&#39;</span> <span class=p>...</span> <span class=o>%</span><span class=err>}</span></code> Cuando es un template dentro de la app, que enlaza desde el <code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> de la propia app.</li> </ol> <h2 id=vistas-basadas-en-clases>Vistas Basadas en Clases<a class=headerlink href=#vistas-basadas-en-clases title="Permanent link">&para;</a></h2> <p>En el <code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> importo el modelo que quiera, por ejemplo <code class=codehilite><span class=n>TemplateView</span></code>. Hago que hereden de mi modelo, defino su template, y modifico el contexto con la función <code class=codehilite><span class=n>get_context_data</span><span class=p>()</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.base</span> <span class=kn>import</span> <span class=n>TemplateView</span>

<span class=k>class</span> <span class=nc>HomePageView</span><span class=p>(</span><span class=n>TemplateView</span><span class=p>):</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;core/home.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_context_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
        <span class=n>context</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>get_context_data</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
        <span class=n>context</span><span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Mi chachi web&#39;</span>
        <span class=k>return</span> <span class=n>context</span>

<span class=k>class</span> <span class=nc>SamplePageView</span><span class=p>(</span><span class=n>TemplateView</span><span class=p>):</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;core/sample.html&#39;</span>
</pre></div> </td></tr></table> <p>En el <code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> importo las vistas y las llamo con la función <code class=codehilite><span class=n>as_view</span><span class=p>()</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>HomePageView</span><span class=p>,</span> <span class=n>SamplePageView</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>HomePageView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;home&quot;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;sample/&#39;</span><span class=p>,</span> <span class=n>SamplePageView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;sample&quot;</span><span class=p>),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p>Si la modificación en el contexto es poca, podría hacer en el <code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.base</span> <span class=kn>import</span> <span class=n>TemplateView</span>
<span class=kn>from</span> <span class=nn>django.shortcuts</span> <span class=kn>import</span> <span class=n>render</span>

<span class=k>class</span> <span class=nc>HomePageView</span><span class=p>(</span><span class=n>TemplateView</span><span class=p>):</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;core/home.html&#39;</span>


    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
        <span class=n>context</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=s1>&#39;Mi chachi web&#39;</span><span class=p>}</span>
        <span class=k>return</span> <span class=n>render</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>template_name</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</pre></div> </td></tr></table> <h3 id=listview>ListView<a class=headerlink href=#listview title="Permanent link">&para;</a></h3> <p>Cuando tenemos un modelo, y queremos ver listados varios objetos, una buena opción es usar una <code class=codehilite><span class=n>ListView</span></code>. Si solo quisieramos ver uno en detalle, deberías de optar por <code class=codehilite><span class=n>DetailView</span></code>.</p> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Tendremos que importar <code class=codehilite><span class=n>ListView</span></code>, dentro de la clase definirle que modelo de la bbdd vamos a usar.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.list</span> <span class=kn>import</span> <span class=n>ListView</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>PageListView</span><span class=p>(</span><span class=n>ListView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Modificar las urls</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>PageListView</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>PageListView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;pages&#39;</span><span class=p>),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_list</span><span class=p>.</span><span class=n>html</span></code> -&gt; Veremos que si arrancamos el server da un error, y es porque esta vista usa un template llamado <code class=codehilite><span class=o>&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_list</span><span class=p>.</span><span class=n>html</span></code>. Así que en nuestra carpeta de templates, deberemos de llamar así a su template html. Además, donde tengamos el <code class=codehilite><span class=k>for</span></code> para mostrar todos los elementos, debemos de usar el objeto <code class=codehilite><span class=k>object</span></code> o el nombre del modelo (en este caso <code class=codehilite><span class=n>page</span></code>)</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span># Este sería el genérico
{% for page in object_list %}
# Este sería más específico, pero para el caso es igual
{% for page in page_list %}
</pre></div> </td></tr></table> <h4 id=paginacion>Paginación<a class=headerlink href=#paginacion title="Permanent link">&para;</a></h4> <p>En las <code class=codehilite><span class=n>ListView</span></code> puedes mostrar solo cierto número de objetos en lugar de todo a la vez, y poner un índice típico de</p> <p>&lt;- Anterior <strong>1</strong>, 2, ... Siguiente -&gt;</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Donde tengas la <code class=codehilite><span class=n>ListView</span></code> tienes que añadirle el campo <code class=codehilite><span class=n>paginated_by</span></code> y ponerle un número. Por ejemplo, <code class=codehilite><span class=n>paginated_by</span> <span class=o>=</span> <span class=mi>3</span></code> son 3 elementos por página.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.list</span> <span class=kn>import</span> <span class=n>ListView</span>
<span class=kn>from</span> <span class=nn>registration.models</span> <span class=kn>import</span> <span class=n>Profile</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>ProfileListView</span><span class=p>(</span><span class=n>ListView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Profile</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;profiles/profile_list.html&#39;</span>
    <span class=n>paginate_by</span> <span class=o>=</span> <span class=mi>3</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>template_name</span><span class=o>&gt;</span></code> -&gt; En el template tienes que hacerle el menú para navegar entre páginas. En el ejemplo se adjunta uno hecho con bootstrap.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c>&lt;!-- Menú de paginación --&gt;</span>
{% if is_paginated %}
<span class=p>&lt;</span><span class=nt>nav</span> <span class=na>aria-label</span><span class=o>=</span><span class=s>&quot;Page navigation&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>ul</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;pagination justify-content-center&quot;</span><span class=p>&gt;</span>
        {% if page_obj.has_previous %}
        <span class=p>&lt;</span><span class=nt>li</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-item &quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-link&quot;</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;?page={{ page_obj.previous_page_number }}&quot;</span><span class=p>&gt;</span><span class=ni>&amp;laquo;</span><span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
        {% else %}
        <span class=p>&lt;</span><span class=nt>li</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-item disabled&quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-link&quot;</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;#&quot;</span> <span class=na>tabindex</span><span class=o>=</span><span class=s>&quot;-1&quot;</span><span class=p>&gt;</span><span class=ni>&amp;laquo;</span><span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
        {% endif %}
        {% for i in paginator.page_range %}
        <span class=p>&lt;</span><span class=nt>li</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-item {% if page_obj.number == i %}active{% endif %}&quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-link&quot;</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;?page={{ i }}&quot;</span><span class=p>&gt;</span>{{ i }}<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
        {% endfor %}
        {% if page_obj.has_next %}
        <span class=p>&lt;</span><span class=nt>li</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-item &quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-link&quot;</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;?page={{ page_obj.next_page_number }}&quot;</span><span class=p>&gt;</span><span class=ni>&amp;raquo;</span><span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
        {% else %}
        <span class=p>&lt;</span><span class=nt>li</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-item disabled&quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-link&quot;</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;#&quot;</span> <span class=na>tabindex</span><span class=o>=</span><span class=s>&quot;-1&quot;</span><span class=p>&gt;</span><span class=ni>&amp;raquo;</span><span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
        {% endif %}
    <span class=p>&lt;/</span><span class=nt>ul</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>nav</span><span class=p>&gt;</span>
{% endif %}
</pre></div> </td></tr></table> <p>En este ejemplo te saldrá un warning diciendo que no están ordenados. Para que no salga, te vas al <code class=codehilite><span class=n>models</span><span class=p>.</span><span class=n>py</span></code> de la app donde usas ese modelo de la <code class=codehilite><span class=n>ListView</span></code>, le creas una clase <code class=codehilite><span class=n>Meta</span></code> y le pones el atributo <code class=codehilite><span class=n>ordering</span></code> indicandole en una lista porque que campos los ordenas.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>Profile</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>OneToOneField</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>)</span>
    <span class=n>avatar</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ImageField</span><span class=p>(</span><span class=n>upload_to</span><span class=o>=</span><span class=n>custom_upload_to</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
                               <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bio</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>(</span><span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>link</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>URLField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>

    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>ordering</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;user__username&#39;</span><span class=p>]</span>
</pre></div> </td></tr></table> <h3 id=detailview>DetailView<a class=headerlink href=#detailview title="Permanent link">&para;</a></h3> <p>Para ver en detalle un único elemento de la bbdd, se suele usar <code class=codehilite><span class=n>DetailView</span></code></p> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importar <code class=codehilite><span class=n>DetailView</span></code>, así como el objeto del modelo de la bbdd y definirlo dentro de la clase.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.list</span> <span class=kn>import</span> <span class=n>ListView</span>
<span class=kn>from</span> <span class=nn>django.views.generic.detail</span> <span class=kn>import</span> <span class=n>DetailView</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>PageListView</span><span class=p>(</span><span class=n>ListView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>


<span class=k>class</span> <span class=nc>PageDetailView</span><span class=p>(</span><span class=n>DetailView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Ojo en el pattern, que usa <code class=codehilite><span class=n>pk</span></code> como índice.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>PageListView</span><span class=p>,</span> <span class=n>PageDetailView</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>PageListView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;pages&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&lt;int:pk&gt;/&lt;slug:slug&gt;/&#39;</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;page&#39;</span><span class=p>),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=k>template</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_detail</span><span class=p>.</span><span class=n>html</span></code> -&gt; <code class=codehilite><span class=n>DetailView</span></code> usa un template html llamado <code class=codehilite><span class=o>&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_detail</span><span class=p>.</span><span class=n>html</span></code>, así que debemos nombrar así al nuestro para que lo lea. De nuevo, tenemos que usar <code class=codehilite><span class=k>object</span></code> dentro del template o el nombre del modelo (<code class=codehilite><span class=n>page</span></code> en este caso).</p> <h2 id=vistas-crud>Vistas CRUD<a class=headerlink href=#vistas-crud title="Permanent link">&para;</a></h2> <p>Son un tipo de vistas basadas en clases, que están pensadas para interactuar con la bbdd.</p> <p>Create Read Update Delete</p> <h3 id=createview-vista-crud>CreateView - Vista CRUD<a class=headerlink href=#createview-vista-crud title="Permanent link">&para;</a></h3> <p>Sirve para poder crear una página donde un admin pueda editar / crear un objeto de la bbdd.</p> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importa <code class=codehilite><span class=n>CreateView</span></code>, añade el modelo de la bbdd así como los campos a editar. El campo <code class=codehilite><span class=n>sucess_url</span></code> es la vista que se pondrá cuando hayas completado el formulario</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.shortcuts</span> <span class=kn>import</span> <span class=n>render</span><span class=p>,</span> <span class=n>get_object_or_404</span><span class=p>,</span> <span class=n>get_list_or_404</span>
<span class=kn>from</span> <span class=nn>django.views.generic.list</span> <span class=kn>import</span> <span class=n>ListView</span>
<span class=kn>from</span> <span class=nn>django.views.generic.detail</span> <span class=kn>import</span> <span class=n>DetailView</span>
<span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>CreateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>PageListView</span><span class=p>(</span><span class=n>ListView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>


<span class=k>class</span> <span class=nc>PageDetailView</span><span class=p>(</span><span class=n>DetailView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>


<span class=k>class</span> <span class=nc>PageCreate</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>,</span> <span class=s1>&#39;order&#39;</span><span class=p>]</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importa la vista.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>PageListView</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=p>,</span> <span class=n>PageCreate</span>

<span class=n>pages_patterns</span> <span class=o>=</span> <span class=p>([</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>PageListView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;pages&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&lt;int:pk&gt;/&lt;slug:slug&gt;/&#39;</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;page&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;create/&#39;</span><span class=p>,</span> <span class=n>PageCreate</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;create&#39;</span><span class=p>),</span>
<span class=p>],</span> <span class=s1>&#39;pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=k>template</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_form</span><span class=p>.</span><span class=n>html</span></code> -&gt; <code class=codehilite><span class=n>CreateView</span></code> usa una plantilla llamada <code class=codehilite><span class=o>&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_form</span><span class=p>.</span><span class=n>html</span></code>, así que debes de renombrar así la tuya.</p> <h3 id=updateview-vista-crud>UpdateView - Vista CRUD<a class=headerlink href=#updateview-vista-crud title="Permanent link">&para;</a></h3> <p>Es muy parecida a la anterior, pero ahora lo que vas a hacer es actualizar en lugar de crear.</p> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; La importas y solo necesitas pasarle 3 atributos, el modelo, los campos y por último el <code class=codehilite><span class=n>template_name_suffix</span></code>. Con este campo se le indica que archivo tiene que leer cuando se ejecute (por defecto se pone <code class=codehilite><span class=n>_update_form</span></code>). Para que devuelva una página al ser actualizado, habría que usar como antes el atributo <code class=codehilite><span class=n>succes_url</span></code>. Si quieres que vuelva al mismo sitio (como en el ejemplo), sobreescribes la función <code class=codehilite><span class=n>get_success_url</span></code> y devuelves el mismo objeto (si le añades algún parámetro, luego en el template puedes hacer que le indique al usuario que la actualización ha sido correcta).</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.list</span> <span class=kn>import</span> <span class=n>ListView</span>
<span class=kn>from</span> <span class=nn>django.views.generic.detail</span> <span class=kn>import</span> <span class=n>DetailView</span>
<span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>CreateView</span><span class=p>,</span> <span class=n>UpdateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>PageListView</span><span class=p>(</span><span class=n>ListView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>


<span class=k>class</span> <span class=nc>PageDetailView</span><span class=p>(</span><span class=n>DetailView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>


<span class=k>class</span> <span class=nc>PageCreateView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>,</span> <span class=s1>&#39;order&#39;</span><span class=p>]</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>

<span class=k>class</span> <span class=nc>PageUpdateView</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>,</span> <span class=s1>&#39;order&#39;</span><span class=p>]</span>
    <span class=n>template_name_suffix</span> <span class=o>=</span> <span class=s1>&#39;_update_form&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:update&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>object</span><span class=o>.</span><span class=n>id</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;?ok&#39;</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Debes de pasarle un <code class=codehilite><span class=n>pk</span></code> para poder saber cual objeto editar.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>PageListView</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=p>,</span> <span class=n>PageCreateView</span><span class=p>,</span> <span class=n>PageUpdateView</span>

<span class=n>pages_patterns</span> <span class=o>=</span> <span class=p>([</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>PageListView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;pages&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&lt;int:pk&gt;/&lt;slug:slug&gt;/&#39;</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;page&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;create/&#39;</span><span class=p>,</span> <span class=n>PageCreateView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;create&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;update/&lt;int:pk&gt;/&#39;</span><span class=p>,</span> <span class=n>PageUpdateView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;update&#39;</span><span class=p>),</span>
<span class=p>],</span> <span class=s1>&#39;pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=k>template</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_update_form</span></code> -&gt; Por último, el template que usa esta vista es <code class=codehilite><span class=o>&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_update_form</span></code>, que se lo has definido en el <code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code>.</p> <h3 id=deleteview-vista-crud>DeleteView - Vista CRUD<a class=headerlink href=#deleteview-vista-crud title="Permanent link">&para;</a></h3> <p>Vista para borrar un objeto.</p> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importar la clase <code class=codehilite><span class=n>DeleteView</span></code> y pasarle el modelo así como la url para cuando el borrado se haya completado.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.list</span> <span class=kn>import</span> <span class=n>ListView</span>
<span class=kn>from</span> <span class=nn>django.views.generic.detail</span> <span class=kn>import</span> <span class=n>DetailView</span>
<span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>CreateView</span><span class=p>,</span> <span class=n>UpdateView</span><span class=p>,</span> <span class=n>DeleteView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>PageListView</span><span class=p>(</span><span class=n>ListView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>


<span class=k>class</span> <span class=nc>PageDetailView</span><span class=p>(</span><span class=n>DetailView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>


<span class=k>class</span> <span class=nc>PageCreateView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>,</span> <span class=s1>&#39;order&#39;</span><span class=p>]</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>

<span class=k>class</span> <span class=nc>PageUpdateView</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>,</span> <span class=s1>&#39;order&#39;</span><span class=p>]</span>
    <span class=n>template_name_suffix</span> <span class=o>=</span> <span class=s1>&#39;_update_form&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:update&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>object</span><span class=o>.</span><span class=n>id</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;?ok&#39;</span>

<span class=k>class</span> <span class=nc>PageDeleteView</span><span class=p>(</span><span class=n>DeleteView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Tienes que pasarle un pk o un slug para borrar el elemento.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>PageListView</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=p>,</span> <span class=n>PageCreateView</span><span class=p>,</span> \
    <span class=n>PageUpdateView</span><span class=p>,</span> <span class=n>PageDeleteView</span>

<span class=n>pages_patterns</span> <span class=o>=</span> <span class=p>([</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>PageListView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;pages&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&lt;int:pk&gt;/&lt;slug:slug&gt;/&#39;</span><span class=p>,</span> <span class=n>PageDetailView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;page&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;create/&#39;</span><span class=p>,</span> <span class=n>PageCreateView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;create&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;update/&lt;int:pk&gt;/&#39;</span><span class=p>,</span> <span class=n>PageUpdateView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;update&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;delete/&lt;int:pk&gt;/&#39;</span><span class=p>,</span> <span class=n>PageDeleteView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;delete&#39;</span><span class=p>),</span>
<span class=p>],</span> <span class=s1>&#39;pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=k>template</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_confirm_delete</span><span class=p>.</span><span class=n>html</span></code> -&gt; Por último tienes que crear el formulario de borrado en una template que se llame <code class=codehilite><span class=o>&lt;</span><span class=n>modelo</span><span class=o>&gt;</span><span class=n>_confirm_delete</span><span class=p>.</span><span class=n>html</span></code></p> <h2 id=formularios-para-modelos>Formularios para Modelos<a class=headerlink href=#formularios-para-modelos title="Permanent link">&para;</a></h2> <p>Dentro de tu app, creas un fichero llamado <code class=codehilite><span class=n>forms</span><span class=p>.</span><span class=n>py</span></code> e importas <code class=codehilite><span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span></code>, para crear la estructura de los campos. Al enlazarle un modelo al formulario, este se genera automáticamente.</p> <p><code class=codehilite><span class=n>forms</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importas el módulo <code class=codehilite><span class=n>forms</span></code> y usas su clase <code class=codehilite><span class=n>ModelForm</span></code>. Ahora debes de crear una clase <code class=codehilite><span class=n>Meta</span></code> dentro, con el modelo y los campos. Con el atributo <code class=codehilite><span class=n>widgets</span></code> le indicas que tipo de elemento html va a ser y dentro le pones los css que va a usar con el <code class=codehilite><span class=n>attrs</span></code> y su diccionario. Con <code class=codehilite><span class=n>labels</span></code> puedes cambiarle el texto del título del campo, quitándolo (como en el ejemplo) o poniéndole otro.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>

<span class=k>class</span> <span class=nc>PageForm</span><span class=p>(</span><span class=n>forms</span><span class=o>.</span><span class=n>ModelForm</span><span class=p>):</span>

    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
        <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>,</span> <span class=s1>&#39;order&#39;</span><span class=p>]</span>
        <span class=n>widgets</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>TextInput</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control&#39;</span><span class=p>,</span>
                                            <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Título&#39;</span><span class=p>}),</span>
            <span class=s1>&#39;content&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>Textarea</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control&#39;</span><span class=p>,</span>
                                            <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Contenido&#39;</span><span class=p>}),</span>
            <span class=s1>&#39;order&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>NumberInput</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control&#39;</span><span class=p>,</span>
                                            <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Orden&#39;</span><span class=p>})</span>
        <span class=p>}</span>
        <span class=n>labels</span> <span class=o>=</span> <span class=p>{</span> <span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;order&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>}</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importas el formulario y lo metes dentro de su vista. Ahora el campo <code class=codehilite><span class=n>fields</span></code> no es necesario porque va en el formulario.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>CreateView</span><span class=p>,</span> <span class=n>UpdateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>
<span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>PageForm</span>


<span class=k>class</span> <span class=nc>PageCreateView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>


<span class=k>class</span> <span class=nc>PageUpdateView</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>template_name_suffix</span> <span class=o>=</span> <span class=s1>&#39;_update_form&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:update&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>object</span><span class=o>.</span><span class=n>id</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;?ok&#39;</span>
</pre></div> </td></tr></table> <h3 id=ckeditor-adaptativo>ckeditor adaptativo<a class=headerlink href=#ckeditor-adaptativo title="Permanent link">&para;</a></h3> <p>Para añadir y hacer adaptativo el ckeditor tienes que hacer lo siguiente:</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=k>static</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>css</span><span class=o>/</span><span class=n>custom_ckeditor</span><span class=p>.</span><span class=n>css</span></code> -&gt; Creas un fichero css donde editas los estilos del ckeditor.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>.</span><span class=nc>django-ckeditor-widget</span><span class=o>,</span> <span class=p>.</span><span class=nc>cke_editor_id_content</span> <span class=p>{</span>
    <span class=k>width</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span> <span class=cp>!important</span><span class=p>;</span>
    <span class=k>max-width</span><span class=p>:</span> <span class=mi>821</span><span class=kt>px</span> <span class=cp>!important</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>En el template que uses común para todos los demás templates, importalo y añade el link al css donde lo has a tuneado.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>{% load static %}
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;text/javascript&quot;</span> <span class=na>src</span><span class=o>=</span><span class=s>&quot;{% static &quot;</span><span class=na>ckeditor</span><span class=err>/</span><span class=na>ckeditor-init</span><span class=err>.</span><span class=na>js</span><span class=err>&quot;</span> <span class=err>%}&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;text/javascript&quot;</span> <span class=na>src</span><span class=o>=</span><span class=s>&quot;{% static &quot;</span><span class=na>ckeditor</span><span class=err>/</span><span class=na>ckeditor</span><span class=err>/</span><span class=na>ckeditor</span><span class=err>.</span><span class=na>js</span><span class=err>&quot;</span> <span class=err>%}&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>link</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{% static &#39;pages/css/custom_ckeditor.css&#39; %}&quot;</span> <span class=na>rel</span><span class=o>=</span><span class=s>&quot;stylesheet&quot;</span><span class=p>&gt;</span>
</pre></div> </td></tr></table> <h3 id=usuarios-registrados>Usuarios registrados<a class=headerlink href=#usuarios-registrados title="Permanent link">&para;</a></h3> <p>Es probable que muchos de los formularios solo quieras que los puedan usar usuarios admin o registrados. Siempre que no seas un usuario loggeado, Django te detecta como usuario anónimo, <code class=codehilite><span class=n>AnonymousUser</span></code>.</p> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Para que en tu vista puedas detectar si el usuario está logeado, debes de reescribir el método <code class=codehilite><span class=k>dispatch</span></code> de la clase. En él miras si el usuario está dentro del staff, y si no, lo rediriges donde quieras (por ejemplo, al login del admin).</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>CreateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>
<span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>PageForm</span>
<span class=kn>from</span> <span class=nn>django.shortcuts</span> <span class=kn>import</span> <span class=n>redirect</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>PageCreateView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>dispatch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>is_staff</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;admin:login&#39;</span><span class=p>))</span>
        <span class=k>return</span> <span class=nb>super</span><span class=p>(</span><span class=n>PageCreateView</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</pre></div> </td></tr></table> <h3 id=usuarios-registrados-mixins-manual>Usuarios registrados - Mixins Manual<a class=headerlink href=#usuarios-registrados-mixins-manual title="Permanent link">&para;</a></h3> <p>Si quieres que esa reedireción de antes se use en más vistas, no hace falta que copias ese método en cada vista. Existe un mecanismo llamado <code class=codehilite><span class=n>Mixin</span></code> que permite escribirlo una vez y usarlo en todas.</p> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Creas una clase, que herede de <code class=codehilite><span class=k>object</span></code> (en Python 3, por defecto, todas las clases heredan de <code class=codehilite><span class=k>object</span></code>) y le pones el método <code class=codehilite><span class=k>dispatch</span></code> de antes. Luego en cada vista haces que herede primero de esta nueva clase y luego de su modelo de vista.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>CreateView</span><span class=p>,</span> <span class=n>UpdateView</span><span class=p>,</span> <span class=n>DeleteView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>
<span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>PageForm</span>
<span class=kn>from</span> <span class=nn>django.shortcuts</span> <span class=kn>import</span> <span class=n>redirect</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>StaffRequiredMixin</span><span class=p>():</span>
    <span class=k>def</span> <span class=nf>dispatch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>is_staff</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;admin:login&#39;</span><span class=p>))</span>
        <span class=k>return</span> <span class=nb>super</span><span class=p>(</span><span class=n>StaffRequiredMixin</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>


<span class=k>class</span> <span class=nc>PageCreateView</span><span class=p>(</span><span class=n>StaffRequiredMixin</span><span class=p>,</span> <span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>



<span class=k>class</span> <span class=nc>PageUpdateView</span><span class=p>(</span><span class=n>StaffRequiredMixin</span><span class=p>,</span> <span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>template_name_suffix</span> <span class=o>=</span> <span class=s1>&#39;_update_form&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:update&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>object</span><span class=o>.</span><span class=n>id</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;?ok&#39;</span>


<span class=k>class</span> <span class=nc>PageDeleteView</span><span class=p>(</span><span class=n>StaffRequiredMixin</span><span class=p>,</span> <span class=n>DeleteView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <h3 id=usuarios-registrados-mixins-decorado>Usuarios registrados - Mixins Decorado<a class=headerlink href=#usuarios-registrados-mixins-decorado title="Permanent link">&para;</a></h3> <p>El punto anterior ya se ha automatizado en Django usando decoradores.</p> <p><code class=codehilite><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Tienes que importar por un lado el <code class=codehilite><span class=n>method_decorator</span></code>, que permite usar decoradores de Django, y por otro el decorador <code class=codehilite><span class=n>staff_member_required</span></code>. Ahora en el método <code class=codehilite><span class=k>dispatch</span></code> puedes quitar el <code class=codehilite><span class=k>if</span></code> con la redirección, ya que se va a hacer sola. Ahora en la url al entrar, incluso te dirá donde debe de ir despues de loguearse.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>CreateView</span><span class=p>,</span> <span class=n>UpdateView</span><span class=p>,</span> <span class=n>DeleteView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>
<span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>PageForm</span>
<span class=kn>from</span> <span class=nn>django.shortcuts</span> <span class=kn>import</span> <span class=n>redirect</span>
<span class=kn>from</span> <span class=nn>django.utils.decorators</span> <span class=kn>import</span> <span class=n>method_decorator</span>
<span class=kn>from</span> <span class=nn>django.contrib.admin.views.decorators</span> <span class=kn>import</span> <span class=n>staff_member_required</span>

<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>StaffRequiredMixin</span><span class=p>():</span>

    <span class=nd>@method_decorator</span><span class=p>(</span><span class=n>staff_member_required</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>dispatch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
        <span class=k>return</span> <span class=nb>super</span><span class=p>(</span><span class=n>StaffRequiredMixin</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>


<span class=k>class</span> <span class=nc>PageCreateView</span><span class=p>(</span><span class=n>StaffRequiredMixin</span><span class=p>,</span> <span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>


<span class=k>class</span> <span class=nc>PageUpdateView</span><span class=p>(</span><span class=n>StaffRequiredMixin</span><span class=p>,</span> <span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>template_name_suffix</span> <span class=o>=</span> <span class=s1>&#39;_update_form&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:update&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>object</span><span class=o>.</span><span class=n>id</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;?ok&#39;</span>


<span class=k>class</span> <span class=nc>PageDeleteView</span><span class=p>(</span><span class=n>StaffRequiredMixin</span><span class=p>,</span> <span class=n>DeleteView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p>Pero tener una clase solo para eso no tiene sentido, así que se puede usar el decorador en las propias vistas usando el <code class=codehilite><span class=n>method_decorator</span></code> y pasándole el decorador, así como el método a decorar</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>CreateView</span><span class=p>,</span> <span class=n>UpdateView</span><span class=p>,</span> <span class=n>DeleteView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Page</span>
<span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>PageForm</span>
<span class=kn>from</span> <span class=nn>django.shortcuts</span> <span class=kn>import</span> <span class=n>redirect</span>
<span class=kn>from</span> <span class=nn>django.utils.decorators</span> <span class=kn>import</span> <span class=n>method_decorator</span>
<span class=kn>from</span> <span class=nn>django.contrib.admin.views.decorators</span> <span class=kn>import</span> <span class=n>staff_member_required</span>


<span class=c1># Create your views here.</span>
<span class=nd>@method_decorator</span><span class=p>(</span><span class=n>staff_member_required</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;dispatch&quot;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>PageCreateView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>

<span class=nd>@method_decorator</span><span class=p>(</span><span class=n>staff_member_required</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;dispatch&quot;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>PageUpdateView</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>PageForm</span>
    <span class=n>template_name_suffix</span> <span class=o>=</span> <span class=s1>&#39;_update_form&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:update&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>object</span><span class=o>.</span><span class=n>id</span><span class=p>])</span> <span class=o>+</span> <span class=s1>&#39;?ok&#39;</span>


<span class=nd>@method_decorator</span><span class=p>(</span><span class=n>staff_member_required</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;dispatch&quot;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>PageDeleteView</span><span class=p>(</span><span class=n>DeleteView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Page</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;pages:pages&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p>Existen <strong>2 decoradores más</strong> que son interesantes: <code class=codehilite><span class=n>login_required</span></code> y <code class=codehilite><span class=n>permission_required</span></code>.</p> <h2 id=auth-views>Auth Views<a class=headerlink href=#auth-views title="Permanent link">&para;</a></h2> <p>Django tiene vistas de autenticación ya creadas: login, logout, ... No hace falta crearlas, él las genera.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>proyecto</span><span class=o>&gt;/&lt;</span><span class=n>proyecto</span><span class=o>&gt;/</span><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Generar las urls para las vistas desde <code class=codehilite><span class=n>accounts</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.contrib</span> <span class=kn>import</span> <span class=n>admin</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span><span class=p>,</span> <span class=n>include</span>
<span class=kn>from</span> <span class=nn>pages.urls</span> <span class=kn>import</span> <span class=n>pages_patterns</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;core.urls&#39;</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;pages/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=n>pages_patterns</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;admin/&#39;</span><span class=p>,</span> <span class=n>admin</span><span class=o>.</span><span class=n>site</span><span class=o>.</span><span class=n>urls</span><span class=p>),</span>
    <span class=c1># Paths de Auth</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;accounts/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;django.contrib.auth.urls&#39;</span><span class=p>)),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p>Si abres la url <a href=http://127.0.0.1:8000/accounts/ >accounts</a> te dice todos las urls que hay, como <code class=codehilite><span class=n>accounts</span><span class=o>/</span><span class=n>login</span></code>.</p> <h3 id=loginview>LoginView<a class=headerlink href=#loginview title="Permanent link">&para;</a></h3> <p>Si abres <code class=codehilite><span class=n>accounts</span><span class=o>/</span><span class=n>login</span></code> da error de template. Busca el template <code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>login</span><span class=p>.</span><span class=n>html</span></code>, así que hay que crearlo.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>login</span><span class=p>.</span><span class=n>html</span></code></p> <p><code class=codehilite><span class=n>settings</span><span class=p>.</span><span class=n>py</span></code> -&gt; En el settings del proyecto tendremos que añadir la app al principio de todo, ya que muchos formularios pueden estar con conflicto con otras aplicaciones. También debemos de crear al final las redirecciones con la variable <code class=codehilite><span class=n>LOGIN_REDIRECT_URL</span></code> donde se le indica donde ir al loguearse.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># ...</span>

<span class=n>INSTALLED_APPS</span> <span class=o>=</span> <span class=p>[</span>
    <span class=s1>&#39;registration.apps.RegistrationConfig&#39;</span><span class=p>,</span>
    <span class=s1>&#39;django.contrib.admin&#39;</span><span class=p>,</span>
    <span class=s1>&#39;django.contrib.auth&#39;</span><span class=p>,</span>
    <span class=s1>&#39;django.contrib.contenttypes&#39;</span><span class=p>,</span>
    <span class=s1>&#39;django.contrib.sessions&#39;</span><span class=p>,</span>
    <span class=s1>&#39;django.contrib.messages&#39;</span><span class=p>,</span>
    <span class=s1>&#39;django.contrib.staticfiles&#39;</span><span class=p>,</span>
    <span class=s1>&#39;ckeditor&#39;</span><span class=p>,</span>
    <span class=s1>&#39;core.apps.CoreConfig&#39;</span><span class=p>,</span>
    <span class=s1>&#39;pages.apps.PagesConfig&#39;</span><span class=p>,</span>
<span class=p>]</span>
<span class=c1># ...</span>

<span class=c1># Auth redirects</span>
<span class=n>LOGIN_REDIRECT_URL</span> <span class=o>=</span> <span class=s1>&#39;home&#39;</span>
</pre></div> </td></tr></table> <p>Luego en el template donde lo vayas a usar simplemente usa <code class=codehilite><span class=err>{</span><span class=o>%</span> <span class=n>url</span> <span class=s1>&#39;login&#39;</span> <span class=o>%</span><span class=err>}</span></code></p> <h3 id=logoutview>LogoutView<a class=headerlink href=#logoutview title="Permanent link">&para;</a></h3> <p>Es parecido al anterior. En este caso solo tienes que definir la variable <code class=codehilite><span class=n>LOGOUT_REDIRECT_URL</span></code> en el <code class=codehilite><span class=n>settings</span></code></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># Auth redirects</span>
<span class=n>LOGIN_REDIRECT_URL</span> <span class=o>=</span> <span class=s1>&#39;pages:pages&#39;</span>
<span class=n>LOGOUT_REDIRECT_URL</span> <span class=o>=</span> <span class=s1>&#39;home&#39;</span>
</pre></div> </td></tr></table> <p>Y luego en algún template puedes enlazar la acción con <code class=codehilite><span class=err>{</span><span class=o>%</span> <span class=n>url</span> <span class=s1>&#39;logout&#39;</span> <span class=o>%</span><span class=err>}</span></code></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>&lt;</span><span class=nt>ul</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;navbar-nav&quot;</span><span class=p>&gt;</span>
    {% if not request.user.is_authenticated %}
        <span class=p>&lt;</span><span class=nt>li</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;nav-item&quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;nav-link&quot;</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{% url &#39;login&#39; %}&quot;</span><span class=p>&gt;</span>Acceder<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
    {% else %}
        <span class=p>&lt;</span><span class=nt>li</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;nav-item&quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;nav-link&quot;</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{% url &#39;logout&#39; %}&quot;</span><span class=p>&gt;</span>Salir<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
    {% endif %}
<span class=p>&lt;/</span><span class=nt>ul</span><span class=p>&gt;</span>
</pre></div> </td></tr></table> <h2 id=registro-de-usuario>Registro de Usuario<a class=headerlink href=#registro-de-usuario title="Permanent link">&para;</a></h2> <p>Se suele hacer en una app aparte (<code class=codehilite><span class=n>registration</span></code> por ejemplo).</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importa el formulario de creación de usuario <code class=codehilite><span class=n>UserCreationForm</span></code> y una vista genérica de creación como <code class=codehilite><span class=n>CreateView</span></code>. Dentro de esta se le pasa el formulario en el atributo <code class=codehilite><span class=n>form_class</span></code> así como su template. También debes de devolver la redirección con algún parámetro que permita saber que todo ha ido correcto.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.contrib.auth.forms</span> <span class=kn>import</span> <span class=n>UserCreationForm</span>
<span class=kn>from</span> <span class=nn>django.views.generic</span> <span class=kn>import</span> <span class=n>CreateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>SignUpView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>UserCreationForm</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/signup.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;?register&#39;</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span><span class=p>,</span> <span class=n>include</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>SignUpView</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;signup/&#39;</span><span class=p>,</span> <span class=n>SignUpView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;signup&#39;</span><span class=p>),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>proyecto</span><span class=o>&gt;/</span><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.contrib</span> <span class=kn>import</span> <span class=n>admin</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span><span class=p>,</span> <span class=n>include</span>
<span class=kn>from</span> <span class=nn>pages.urls</span> <span class=kn>import</span> <span class=n>pages_patterns</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;core.urls&#39;</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;pages/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=n>pages_patterns</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;admin/&#39;</span><span class=p>,</span> <span class=n>admin</span><span class=o>.</span><span class=n>site</span><span class=o>.</span><span class=n>urls</span><span class=p>),</span>
    <span class=c1># Paths de Auth</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;accounts/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;django.contrib.auth.urls&#39;</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;accounts/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;registration.urls&#39;</span><span class=p>)),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>template_name</span><span class=o>&gt;</span></code> -&gt; Es un formulario normal y corriente.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=codehilite><pre><span></span>{% extends &#39;core/base.html&#39; %}
{% load static %}
{% block title %}Registro{% endblock %}
{% block content %}
<span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;.</span><span class=nc>errorlist</span><span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>red</span><span class=p>;}&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>main</span> <span class=na>role</span><span class=o>=</span><span class=s>&quot;main&quot;</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;container&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;row mt-3&quot;</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;col-md-9 mx-auto mb-5&quot;</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>method</span><span class=o>=</span><span class=s>&quot;post&quot;</span><span class=p>&gt;</span>{% csrf_token %}
          <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;mb-4&quot;</span><span class=p>&gt;</span>Registro<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
          {{form.as_p}}
          <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;submit&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;btn btn-primary btn-block&quot;</span> <span class=na>value</span><span class=o>=</span><span class=s>&quot;Confirmar&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
{% endblock %}
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>success_url</span><span class=o>&gt;</span></code> -&gt; Para poder ver si te ha ido bien podrías añadir</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span>{% if &#39;register&#39; in request.GET %}
    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>style</span><span class=o>=</span><span class=s>&quot;color:green;&quot;</span><span class=p>&gt;</span>Usuario registrado correctamente, ya puedes loguearte.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
{% endif %}
</pre></div> </td></tr></table> <h3 id=customizar-el-registro>Customizar el registro<a class=headerlink href=#customizar-el-registro title="Permanent link">&para;</a></h3> <p>Para customizar el formulario de registro debes de trastearlo en tiempo de ejecución para no perder el que ya hay hecho.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Tienes que sobreescribir el método <code class=codehilite><span class=n>get_form</span><span class=p>()</span></code>, modificando sus campos, que son: <code class=codehilite><span class=n>username</span></code>, <code class=codehilite><span class=n>password1</span></code> y <code class=codehilite><span class=n>password2</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.contrib.auth.forms</span> <span class=kn>import</span> <span class=n>UserCreationForm</span>
<span class=kn>from</span> <span class=nn>django.views.generic</span> <span class=kn>import</span> <span class=n>CreateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>SignUpView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>UserCreationForm</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/signup.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;?register&#39;</span>

    <span class=k>def</span> <span class=nf>get_form</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form_class</span><span class=o>=</span><span class=bp>None</span><span class=p>):</span>
        <span class=n>form</span> <span class=o>=</span> <span class=nb>super</span><span class=p>(</span><span class=n>SignUpView</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>get_form</span><span class=p>()</span>
        <span class=c1># Customización en tiempo real</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>TextInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Nombre de usuario&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Contraseña&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Repite la contraseña&#39;</span><span class=p>})</span>
        <span class=k>return</span> <span class=n>form</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>template_name</span><span class=o>&gt;</span></code> -&gt; Si quieres quitar todos los <code class=codehilite><span class=n>labels</span></code>, lo puedes hacer desde el fichero anterior o simplemente en tu template pones</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span><span class=nt>label</span><span class=p>{</span><span class=k>display</span><span class=p>:</span><span class=kc>none</span><span class=p>}&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</pre></div> </td></tr></table> <h3 id=anadir-email-como-requisito>Añadir email como requisito<a class=headerlink href=#anadir-email-como-requisito title="Permanent link">&para;</a></h3> <p>Para que añadas un email al registro lo mejor es extender el formulario ya existente en Django.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>forms</span><span class=p>.</span><span class=n>py</span></code> -&gt; Crea este fichero para extender el formulario. Añades el atributo <code class=codehilite><span class=n>email</span></code>. En la clase <code class=codehilite><span class=n>Meta</span></code> añades el atributo. con el método <code class=codehilite><span class=n>clean_</span><span class=o>&lt;</span><span class=n>field</span><span class=o>&gt;</span></code> haces una validación, en este caso <code class=codehilite><span class=n>clean_email</span></code> lo haces para que el <code class=codehilite><span class=n>email</span></code> sea único para cada usuario (no puede haber dos usuarios con el mismo email) Si el email no existe, puede registrarse, sino, lanza un error de validación.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.forms</span> <span class=kn>import</span> <span class=n>UserCreationForm</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>

<span class=k>class</span> <span class=nc>UserCreationFormWithEmail</span><span class=p>(</span><span class=n>UserCreationForm</span><span class=p>):</span>
    <span class=n>email</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>EmailField</span><span class=p>(</span>
        <span class=n>required</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
        <span class=n>help_text</span><span class=o>=</span><span class=s1>&#39;Requerido, 254 caracteres como máximo y que sea válido&#39;</span><span class=p>)</span>

    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>User</span>
        <span class=n>fields</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s1>&#39;email&#39;</span><span class=p>,</span> <span class=s1>&#39;password1&#39;</span><span class=p>,</span> <span class=s1>&#39;password2&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>clean_email</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>email</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=k>raise</span> <span class=n>forms</span><span class=o>.</span><span class=n>ValidationError</span><span class=p>(</span><span class=s1>&#39;El email ya existe, usa otro.&#39;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>email</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Cambiar el formulario anterior por el nuevo extendido, así como las modificaciones de su campo.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>UserCreationFormWithEmail</span>
<span class=kn>from</span> <span class=nn>django.views.generic</span> <span class=kn>import</span> <span class=n>CreateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>SignUpView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>UserCreationFormWithEmail</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/signup.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;?register&#39;</span>

    <span class=k>def</span> <span class=nf>get_form</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form_class</span><span class=o>=</span><span class=bp>None</span><span class=p>):</span>
        <span class=n>form</span> <span class=o>=</span> <span class=nb>super</span><span class=p>(</span><span class=n>SignUpView</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>get_form</span><span class=p>()</span>
        <span class=c1># Customización en tiempo real</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>TextInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Nombre de usuario&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>EmailInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Email&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Contraseña&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Repite la contraseña&#39;</span><span class=p>})</span>
        <span class=k>return</span> <span class=n>form</span>
</pre></div> </td></tr></table> <h3 id=recuperar-contrasena>Recuperar contraseña<a class=headerlink href=#recuperar-contrasena title="Permanent link">&para;</a></h3> <p>Existen diferentes opciones, pero una típica es tener un servidor de correo SMTP que manda email con el link para el proceso de recuperación de contraseña. Aquí vas a hacer un truco para debug, que es tener un fichero local donde almacenas las credenciales.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>proyecto</span><span class=o>&gt;/</span><span class=n>settings</span><span class=p>.</span><span class=n>py</span></code> -&gt; Añades lo siguiente al final. Con <code class=codehilite><span class=n>EMAIL_BACKEND</span></code> le estas diciendo que use un backend de ficheros de prueba para el email. Con <code class=codehilite><span class=n>EMAIL_FILE_PATH</span></code> le indicas donde guardar ese fichero.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># Email</span>
<span class=k>if</span> <span class=n>DEBUG</span><span class=p>:</span>
    <span class=n>EMAIL_BACKEND</span> <span class=o>=</span> <span class=s2>&quot;django.core.mail.backends.filebased.EmailBackend&quot;</span>
    <span class=n>EMAIL_FILE_PATH</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>BASE_DIR</span><span class=p>,</span> <span class=s1>&#39;sent_emails&#39;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=c1># Configuración del servidor de correo SMTP real de producción</span>
    <span class=k>pass</span>
</pre></div> </td></tr></table> <p>Ahora te va a tocar sobreescribir los 4 templates que Django usa para recuperar la contraseña, ya que los que él ofrece son de forma admin, y tu quieres verlo como un usuario que ve el frontend. Los templates que debes crear son:</p> <ul> <li><code class=codehilite><span class=n>password_reset_form</span><span class=p>.</span><span class=n>html</span></code> -&gt; Pedir nueva contraseña.</li> <li><code class=codehilite><span class=n>password_reset_done</span><span class=p>.</span><span class=n>html</span></code> -&gt; Email con instrucciones enviado.</li> <li><code class=codehilite><span class=n>password_reset_confirm</span><span class=p>.</span><span class=n>html</span></code> -&gt; Definir nueva contraseña.</li> <li><code class=codehilite><span class=n>password_reset_complete</span><span class=p>.</span><span class=n>html</span></code> -&gt; Contraseña cambiada.</li> </ul> <p>Por último, en el template login deberías de añadir la típica línea para si has olvidado la contraseña</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{% url &#39;password_reset&#39; %}&quot;</span><span class=p>&gt;</span>He olvidado mi contraseña<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</pre></div> </td></tr></table> <p>Para ver todos los templates de Django para cuentas puedes verlo en</p> <h2 id=perfil-de-usuario>Perfil de Usuario<a class=headerlink href=#perfil-de-usuario title="Permanent link">&para;</a></h2> <h3 id=crear-perfil>Crear perfil<a class=headerlink href=#crear-perfil title="Permanent link">&para;</a></h3> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>models</span><span class=p>.</span><span class=n>py</span></code> -&gt; Creamos un modelo <code class=codehilite><span class=n>Profile</span></code>, que tiene que tener una relación 1-1 con un usuario, una foto, biografía, web.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>


<span class=c1># Create your models here.</span>
<span class=k>class</span> <span class=nc>Profile</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>OneToOneField</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>)</span>
    <span class=n>avatar</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ImageField</span><span class=p>(</span><span class=n>upload_to</span><span class=o>=</span><span class=s1>&#39;profiles&#39;</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bio</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>(</span><span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>link</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>URLField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>settings</span><span class=p>.</span><span class=n>py</span></code> -&gt; Hay que despachar los ficheros media del avatar y no tocar la redirección del login.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># Auth redirects</span>
<span class=c1>#LOGIN_REDIRECT_URL = &#39;pages:pages&#39;</span>
<span class=n>LOGOUT_REDIRECT_URL</span> <span class=o>=</span> <span class=s1>&#39;home&#39;</span>


<span class=c1># Media Files</span>
<span class=n>MEDIA_URL</span> <span class=o>=</span> <span class=s1>&#39;/media/&#39;</span>
<span class=n>MEDIA_ROOT</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>BASE_DIR</span><span class=p>,</span> <span class=s1>&#39;media&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Añadir al <code class=codehilite><span class=n>urlpatterns</span></code> del proyecto donde se despachan los ficheros media.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.contrib</span> <span class=kn>import</span> <span class=n>admin</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span><span class=p>,</span> <span class=n>include</span>
<span class=kn>from</span> <span class=nn>pages.urls</span> <span class=kn>import</span> <span class=n>pages_patterns</span>
<span class=kn>from</span> <span class=nn>django.conf</span> <span class=kn>import</span> <span class=n>settings</span>


<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;core.urls&#39;</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;pages/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=n>pages_patterns</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;admin/&#39;</span><span class=p>,</span> <span class=n>admin</span><span class=o>.</span><span class=n>site</span><span class=o>.</span><span class=n>urls</span><span class=p>),</span>
    <span class=c1># Paths de Auth</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;accounts/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;django.contrib.auth.urls&#39;</span><span class=p>)),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;accounts/&#39;</span><span class=p>,</span> <span class=n>include</span><span class=p>(</span><span class=s1>&#39;registration.urls&#39;</span><span class=p>)),</span>
<span class=p>]</span>

<span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>:</span>
    <span class=kn>from</span> <span class=nn>django.conf.urls.static</span> <span class=kn>import</span> <span class=n>static</span>
    <span class=n>urlpatterns</span> <span class=o>+=</span> <span class=n>static</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>MEDIA_URL</span><span class=p>,</span> <span class=n>document_root</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>MEDIA_ROOT</span><span class=p>)</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Crear su vista, con el decorador <code class=codehilite><span class=n>login_required</span></code> para cuando estés logueado.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>UserCreationFormWithEmail</span>
<span class=kn>from</span> <span class=nn>django.views.generic</span> <span class=kn>import</span> <span class=n>CreateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>
<span class=kn>from</span> <span class=nn>django.views.generic.base</span> <span class=kn>import</span> <span class=n>TemplateView</span>
<span class=kn>from</span> <span class=nn>django.utils.decorators</span> <span class=kn>import</span> <span class=n>method_decorator</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.decorators</span> <span class=kn>import</span> <span class=n>login_required</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>SignUpView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>UserCreationFormWithEmail</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/signup.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;?register&#39;</span>

    <span class=k>def</span> <span class=nf>get_form</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form_class</span><span class=o>=</span><span class=bp>None</span><span class=p>):</span>
        <span class=n>form</span> <span class=o>=</span> <span class=nb>super</span><span class=p>(</span><span class=n>SignUpView</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>get_form</span><span class=p>()</span>
        <span class=c1># Customización en tiempo real</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>TextInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Nombre de usuario&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>EmailInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Email&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Contraseña&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Repite la contraseña&#39;</span><span class=p>})</span>
        <span class=k>return</span> <span class=n>form</span>


<span class=nd>@method_decorator</span><span class=p>(</span><span class=n>login_required</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;dispatch&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>ProfileUpdate</span><span class=p>(</span><span class=n>TemplateView</span><span class=p>):</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/profile_form.html&#39;</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>template_name</span><span class=o>&gt;</span></code> -&gt; Crear su template.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class=code><div class=codehilite><pre><span></span>{% extends &#39;core/base.html&#39; %}
{% load static %}
{% block title %}Perfil{% endblock %}
{% block content %}
<span class=p>&lt;</span><span class=nt>main</span> <span class=na>role</span><span class=o>=</span><span class=s>&quot;main&quot;</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;container&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;row mt-3 mb-5&quot;</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;col-md-9 mx-auto&quot;</span><span class=p>&gt;</span>
          <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>Perfil<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
          <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>method</span><span class=o>=</span><span class=s>&quot;post&quot;</span><span class=p>&gt;</span>{% csrf_token %}
            {{ form.as_p }}
            <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;text-center&quot;</span><span class=p>&gt;</span>
              <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;submit&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;btn btn-primary btn-block&quot;</span> <span class=na>value</span><span class=o>=</span><span class=s>&quot;Actualizar&quot;</span> <span class=p>/&gt;</span>
            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
          <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
{% endblock %}
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Redireccionarla en la urls.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span><span class=p>,</span> <span class=n>include</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>SignUpView</span><span class=p>,</span> <span class=n>ProfileUpdate</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;signup/&#39;</span><span class=p>,</span> <span class=n>SignUpView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;signup&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;profile/&#39;</span><span class=p>,</span> <span class=n>ProfileUpdate</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;profile&#39;</span><span class=p>),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>core</span><span class=o>/</span><span class=n>templates</span><span class=o>/</span><span class=n>base</span><span class=p>.</span><span class=n>html</span></code> -&gt; Añadir un enlace.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>&lt;</span><span class=nt>li</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;nav-item&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;nav-link&quot;</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{% url &#39;profile&#39; %}&quot;</span><span class=p>&gt;</span>Perfil<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
</pre></div> </td></tr></table> <p>Por último hacemos las migraciones.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>python manage.py makemigrations &lt;app&gt;
python manage.py migrate &lt;app&gt;
</pre></div> </td></tr></table> <h3 id=perfil-editable>Perfil editable<a class=headerlink href=#perfil-editable title="Permanent link">&para;</a></h3> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;</span><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Tienes que hacer que la vista herede de <code class=codehilite><span class=n>UpdateView</span></code> (poniéndole su modelo y que campos son editables). Para que no de error a la hora de editar, se debe sobreescribir el método <code class=codehilite><span class=n>get_object</span></code>, donde hay que obtener el usuario de la propia <code class=codehilite><span class=n>request</span></code> para poder usarlo en la vista. Al obtener el usuario, si este no existe, la queryset puede petar, así que por eso hay que usar <code class=codehilite><span class=n>get_or_create</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>UserCreationFormWithEmail</span>
<span class=kn>from</span> <span class=nn>django.views.generic</span> <span class=kn>import</span> <span class=n>CreateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>
<span class=kn>from</span> <span class=nn>django.utils.decorators</span> <span class=kn>import</span> <span class=n>method_decorator</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.decorators</span> <span class=kn>import</span> <span class=n>login_required</span>
<span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>UpdateView</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Profile</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>SignUpView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>UserCreationFormWithEmail</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/signup.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;?register&#39;</span>

    <span class=k>def</span> <span class=nf>get_form</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form_class</span><span class=o>=</span><span class=bp>None</span><span class=p>):</span>
        <span class=n>form</span> <span class=o>=</span> <span class=nb>super</span><span class=p>(</span><span class=n>SignUpView</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>get_form</span><span class=p>()</span>
        <span class=c1># Customización en tiempo real</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>TextInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Nombre de usuario&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>EmailInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Email&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Contraseña&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Repite la contraseña&#39;</span><span class=p>})</span>
        <span class=k>return</span> <span class=n>form</span>


<span class=nd>@method_decorator</span><span class=p>(</span><span class=n>login_required</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;dispatch&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>ProfileUpdate</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Profile</span>
    <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;avatar&#39;</span><span class=p>,</span> <span class=s1>&#39;bio&#39;</span><span class=p>,</span> <span class=s1>&#39;link&#39;</span><span class=p>]</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;profile&#39;</span><span class=p>)</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/profile_form.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_object</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=c1># Obtener (o crear si no existe) el objeto a editar</span>
        <span class=n>profile</span><span class=p>,</span> <span class=n>created</span> <span class=o>=</span> <span class=n>Profile</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get_or_create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>profile</span>
</pre></div> </td></tr></table> <p>En el template, para poder ver el url de la imagen del avatar tienes que usar esto en el formulario</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span> <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>method</span><span class=o>=</span><span class=s>&quot;post&quot;</span> <span class=na>enctype</span><span class=o>=</span><span class=s>&quot;multipart/form-data&quot;</span><span class=p>&gt;</span>{% csrf_token %}
</pre></div> </td></tr></table> <h3 id=customizando-formulario-de-perfil>Customizando formulario de Perfil<a class=headerlink href=#customizando-formulario-de-perfil title="Permanent link">&para;</a></h3> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>forms</span><span class=p>.</span><span class=n>py</span></code> -&gt; Debes de importar el modelo. Crear un formulario que herede de <code class=codehilite><span class=n>forms</span><span class=p>.</span><span class=n>ModelForm</span></code>. Dentro crear su clase <code class=codehilite><span class=n>Meta</span></code> con el modelo, los campos y sus widgets para modificarlos.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.forms</span> <span class=kn>import</span> <span class=n>UserCreationForm</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Profile</span>


<span class=k>class</span> <span class=nc>UserCreationFormWithEmail</span><span class=p>(</span><span class=n>UserCreationForm</span><span class=p>):</span>
    <span class=n>email</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>EmailField</span><span class=p>(</span>
        <span class=n>required</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
        <span class=n>help_text</span><span class=o>=</span><span class=s1>&#39;Requerido, 254 caracteres como máximo y que sea válido&#39;</span><span class=p>)</span>

    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>User</span>
        <span class=n>fields</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s1>&#39;email&#39;</span><span class=p>,</span> <span class=s1>&#39;password1&#39;</span><span class=p>,</span> <span class=s1>&#39;password2&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>clean_email</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>email</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=k>raise</span> <span class=n>forms</span><span class=o>.</span><span class=n>ValidationError</span><span class=p>(</span><span class=s1>&#39;El email ya existe, usa otro.&#39;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>email</span>


<span class=k>class</span> <span class=nc>ProfileForm</span><span class=p>(</span><span class=n>forms</span><span class=o>.</span><span class=n>ModelForm</span><span class=p>):</span>
    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>Profile</span>
        <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;avatar&#39;</span><span class=p>,</span> <span class=s1>&#39;bio&#39;</span><span class=p>,</span> <span class=s1>&#39;link&#39;</span><span class=p>]</span>
        <span class=n>widgets</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;avatar&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>ClearableFileInput</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span>
                <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control-file mt-3&#39;</span>
            <span class=p>}),</span>
            <span class=s1>&#39;bio&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>Textarea</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span>
                <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mt-3&#39;</span><span class=p>,</span>
                <span class=s1>&#39;rows&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
                <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Biografia&#39;</span>
            <span class=p>}),</span>
            <span class=s1>&#39;link&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>URLInput</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span>
                <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mt-3&#39;</span><span class=p>,</span>
                <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Enlace&#39;</span>
            <span class=p>}),</span>
        <span class=p>}</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Importa el formulario nuevo y cambia el atributo <code class=codehilite><span class=n>model</span></code> por el de <code class=codehilite><span class=n>form_class</span></code>, poniendole el formulario. El campo <code class=codehilite><span class=n>fields</span></code> ya no es necesario pues está en el formulario.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>UserCreationFormWithEmail</span><span class=p>,</span> <span class=n>ProfileForm</span>

<span class=c1># ...</span>

<span class=nd>@method_decorator</span><span class=p>(</span><span class=n>login_required</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;dispatch&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>ProfileUpdate</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>ProfileForm</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;profile&#39;</span><span class=p>)</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/profile_form.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_object</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=c1># Obtener (o crear si no existe) el objeto a editar</span>
        <span class=n>profile</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>Profile</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get_or_create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>profile</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>template_name</span><span class=o>&gt;</span></code> -&gt; Modifica el formulario a pelo a tu gusto. En este ejemplo se ha puesto una imagen por defecto <code class=codehilite><span class=k>no</span><span class=o>-</span><span class=n>avatar</span><span class=p>.</span><span class=n>jpg</span></code> en <code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=k>static</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>img</span><span class=o>/</span><span class=k>no</span><span class=o>-</span><span class=n>avatar</span><span class=p>.</span><span class=n>jpg</span></code> para cuando el usuario no tenga, o borre la imagen, aparezca esta.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class=code><div class=codehilite><pre><span></span>{% extends &#39;core/base.html&#39; %}
{% load static %}
{% block title %}Perfil{% endblock %}
{% block content %}
<span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;.</span><span class=nc>errorlist</span><span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>red</span><span class=p>;}</span> <span class=nt>label</span><span class=p>{</span><span class=k>display</span><span class=p>:</span><span class=kc>none</span><span class=p>}&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>main</span> <span class=na>role</span><span class=o>=</span><span class=s>&quot;main&quot;</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;container&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;row mt-3&quot;</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;col-md-9 mx-auto mb-5&quot;</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>method</span><span class=o>=</span><span class=s>&quot;post&quot;</span> <span class=na>enctype</span><span class=o>=</span><span class=s>&quot;multipart/form-data&quot;</span><span class=p>&gt;</span>{% csrf_token %}
          <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;row&quot;</span><span class=p>&gt;</span>
            <span class=c>&lt;!-- Previa del avatar --&gt;</span>
            <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;col-md-2&quot;</span><span class=p>&gt;</span>
              {% if request.user.profile.avatar %}
                <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&quot;{{request.user.profile.avatar.url}}&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;img-fluid&quot;</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;mt-1&quot;</span><span class=p>&gt;</span>¿Borrar? <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;checkbox&quot;</span> <span class=na>id</span><span class=o>=</span><span class=s>&quot;avatar-clear&quot;</span> <span class=na>name</span><span class=o>=</span><span class=s>&quot;avatar-clear&quot;</span> <span class=p>/&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
              {% else %}
              <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&quot;{% static &#39;registration/img/no-avatar.jpg&#39; %}&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;img-fluid&quot;</span><span class=p>&gt;</span>
              {% endif %}
            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
            <span class=c>&lt;!-- Formulario --&gt;</span>
            <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;col-md-10&quot;</span><span class=p>&gt;</span>
              <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>Perfil<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
              <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;file&quot;</span> <span class=na>name</span><span class=o>=</span><span class=s>&quot;avatar&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;form-control-file mt-3&quot;</span> <span class=na>id</span><span class=o>=</span><span class=s>&quot;id_avatar&quot;</span><span class=p>&gt;</span>
              {{ form.bio }}
              {{ form.link }}
              <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;submit&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;btn btn-primary btn-block mt-3&quot;</span> <span class=na>value</span><span class=o>=</span><span class=s>&quot;Actualizar&quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
          <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
{% endblock %}
</pre></div> </td></tr></table> <h3 id=email-editable>Email editable<a class=headerlink href=#email-editable title="Permanent link">&para;</a></h3> <p>Como es solo un campo, y para no tener que destrozar los modelos de formularios y vistas que ya estamos usando, lo mejor es que hagas un formulario solo para este campo.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/&lt;</span><span class=n>template_perfil</span><span class=o>&gt;</span></code> -&gt; Añades un enlace para editar el email.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>forms</span><span class=p>.</span><span class=n>py</span></code> -&gt; Creas el nuevo formulario <code class=codehilite><span class=n>EmailForm</span></code> basándote en uno anterior. Ahora lo que vas a recuperar es un objeto que ya existe y que debe permitir cambiarlo si no existe el nuevo valor.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.forms</span> <span class=kn>import</span> <span class=n>UserCreationForm</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Profile</span>


<span class=k>class</span> <span class=nc>UserCreationFormWithEmail</span><span class=p>(</span><span class=n>UserCreationForm</span><span class=p>):</span>
    <span class=n>email</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>EmailField</span><span class=p>(</span>
        <span class=n>required</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
        <span class=n>help_text</span><span class=o>=</span><span class=s1>&#39;Requerido, 254 caracteres como máximo y que sea válido&#39;</span><span class=p>)</span>

    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>User</span>
        <span class=n>fields</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s1>&#39;email&#39;</span><span class=p>,</span> <span class=s1>&#39;password1&#39;</span><span class=p>,</span> <span class=s1>&#39;password2&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>clean_email</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>email</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=k>raise</span> <span class=n>forms</span><span class=o>.</span><span class=n>ValidationError</span><span class=p>(</span><span class=s1>&#39;El email ya existe, usa otro.&#39;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>email</span>


<span class=k>class</span> <span class=nc>ProfileForm</span><span class=p>(</span><span class=n>forms</span><span class=o>.</span><span class=n>ModelForm</span><span class=p>):</span>
    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>Profile</span>
        <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;avatar&#39;</span><span class=p>,</span> <span class=s1>&#39;bio&#39;</span><span class=p>,</span> <span class=s1>&#39;link&#39;</span><span class=p>]</span>
        <span class=n>widgets</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;avatar&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>ClearableFileInput</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span>
                <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control-file mt-3&#39;</span>
            <span class=p>}),</span>
            <span class=s1>&#39;bio&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>Textarea</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span>
                <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mt-3&#39;</span><span class=p>,</span>
                <span class=s1>&#39;rows&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
                <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Biografia&#39;</span>
            <span class=p>}),</span>
            <span class=s1>&#39;link&#39;</span><span class=p>:</span> <span class=n>forms</span><span class=o>.</span><span class=n>URLInput</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>{</span>
                <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mt-3&#39;</span><span class=p>,</span>
                <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Enlace&#39;</span>
            <span class=p>}),</span>
        <span class=p>}</span>


<span class=k>class</span> <span class=nc>EmailForm</span><span class=p>(</span><span class=n>forms</span><span class=o>.</span><span class=n>ModelForm</span><span class=p>):</span>
    <span class=n>email</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>EmailField</span><span class=p>(</span>
        <span class=n>required</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
        <span class=n>help_text</span><span class=o>=</span><span class=s1>&#39;Requerido, 254 caracteres como máximo y que sea válido&#39;</span><span class=p>)</span>

    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>User</span>
        <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span>

    <span class=k>def</span> <span class=nf>clean_email</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>email</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span>
        <span class=k>if</span> <span class=s1>&#39;email&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>changed_data</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
                <span class=k>raise</span> <span class=n>forms</span><span class=o>.</span><span class=n>ValidationError</span><span class=p>(</span><span class=s1>&#39;El email ya existe, usa otro.&#39;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>email</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>views</span><span class=p>.</span><span class=n>py</span></code> -&gt; Creas su vista <code class=codehilite><span class=n>EmailUpdate</span></code> y lo obtienes (el email) de la propia <code class=codehilite><span class=n>request</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>.forms</span> <span class=kn>import</span> <span class=n>UserCreationFormWithEmail</span><span class=p>,</span> <span class=n>ProfileForm</span><span class=p>,</span> <span class=n>EmailForm</span>
<span class=kn>from</span> <span class=nn>django.views.generic</span> <span class=kn>import</span> <span class=n>CreateView</span>
<span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>reverse_lazy</span>
<span class=kn>from</span> <span class=nn>django</span> <span class=kn>import</span> <span class=n>forms</span>
<span class=kn>from</span> <span class=nn>django.utils.decorators</span> <span class=kn>import</span> <span class=n>method_decorator</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.decorators</span> <span class=kn>import</span> <span class=n>login_required</span>
<span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>UpdateView</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Profile</span>


<span class=c1># Create your views here.</span>
<span class=k>class</span> <span class=nc>SignUpView</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>UserCreationFormWithEmail</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/signup.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;?register&#39;</span>

    <span class=k>def</span> <span class=nf>get_form</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form_class</span><span class=o>=</span><span class=bp>None</span><span class=p>):</span>
        <span class=n>form</span> <span class=o>=</span> <span class=nb>super</span><span class=p>(</span><span class=n>SignUpView</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>get_form</span><span class=p>()</span>
        <span class=c1># Customización en tiempo real</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>TextInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Nombre de usuario&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>EmailInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Email&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Contraseña&#39;</span><span class=p>})</span>
        <span class=n>form</span><span class=o>.</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;password2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>widget</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>PasswordInput</span><span class=p>(</span>
            <span class=n>attrs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;form-control mb2&#39;</span><span class=p>,</span>
                   <span class=s1>&#39;placeholder&#39;</span><span class=p>:</span> <span class=s1>&#39;Repite la contraseña&#39;</span><span class=p>})</span>
        <span class=k>return</span> <span class=n>form</span>


<span class=nd>@method_decorator</span><span class=p>(</span><span class=n>login_required</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;dispatch&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>ProfileUpdate</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>ProfileForm</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;profile&#39;</span><span class=p>)</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/profile_form.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_object</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=c1># Obtener (o crear si no existe) el objeto a editar</span>
        <span class=n>profile</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>Profile</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get_or_create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>profile</span>


<span class=nd>@method_decorator</span><span class=p>(</span><span class=n>login_required</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;dispatch&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>EmailUpdate</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>form_class</span> <span class=o>=</span> <span class=n>EmailForm</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;profile&#39;</span><span class=p>)</span>
    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;registration/profile_email_form.html&#39;</span>

    <span class=k>def</span> <span class=nf>get_object</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=c1># Obtener el objeto a editar</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>urls</span><span class=p>.</span><span class=n>py</span></code> -&gt; Creas su endpoint / url asociada a su vista.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.urls</span> <span class=kn>import</span> <span class=n>path</span>
<span class=kn>from</span> <span class=nn>.views</span> <span class=kn>import</span> <span class=n>SignUpView</span><span class=p>,</span> <span class=n>ProfileUpdate</span><span class=p>,</span> <span class=n>EmailUpdate</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;signup/&#39;</span><span class=p>,</span> <span class=n>SignUpView</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;signup&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;profile/&#39;</span><span class=p>,</span> <span class=n>ProfileUpdate</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;profile&#39;</span><span class=p>),</span>
    <span class=n>path</span><span class=p>(</span><span class=s1>&#39;profile/email/&#39;</span><span class=p>,</span> <span class=n>EmailUpdate</span><span class=o>.</span><span class=n>as_view</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;profile_email&#39;</span><span class=p>),</span>
<span class=p>]</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>template_name</span></code> -&gt; Por último creas la template.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=codehilite><pre><span></span>{% extends &#39;core/base.html&#39; %}
{% load static %}
{% block title %}Email{% endblock %}
{% block content %}
<span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;.</span><span class=nc>errorlist</span><span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>red</span><span class=p>;}</span> <span class=nt>label</span><span class=p>{</span><span class=k>display</span><span class=p>:</span><span class=kc>none</span><span class=p>}&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>main</span> <span class=na>role</span><span class=o>=</span><span class=s>&quot;main&quot;</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;container&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;row mt-3&quot;</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;col-md-9 mx-auto mb-5&quot;</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>method</span><span class=o>=</span><span class=s>&quot;post&quot;</span><span class=p>&gt;</span>{% csrf_token %}
          <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;mb-4&quot;</span><span class=p>&gt;</span>Email<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
          {{form.as_p}}
          <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;submit&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;btn btn-primary btn-block&quot;</span> <span class=na>value</span><span class=o>=</span><span class=s>&quot;Actualizar&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
{% endblock %}
</pre></div> </td></tr></table> <h3 id=contrasena-editable>Contraseña Editable<a class=headerlink href=#contrasena-editable title="Permanent link">&para;</a></h3> <p>Al igual que sucedía anteriormente cuando querías cambiar la contraseña (Recuperar Contraseña), Django tiene urls de Admin para editar la contraseña. Tu vas a usar:</p> <ul> <li><code class=codehilite><span class=n>password_change</span><span class=o>/</span></code> -&gt; Vista con nombre <code class=codehilite><span class=n>password_change</span></code> y template que usa un formulario <code class=codehilite><span class=n>password_change_form</span><span class=o>-</span><span class=n>html</span></code>.</li> <li><code class=codehilite><span class=n>password_change</span><span class=o>/</span><span class=n>done</span></code> -&gt; Vista con nombre <code class=codehilite><span class=n>password_change_done</span></code> y template <code class=codehilite><span class=n>password_change_done</span><span class=p>.</span><span class=n>html</span></code>.</li> </ul> <p>Solo tienes que crear estos dos templates</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>password_change_form</span><span class=p>.</span><span class=n>html</span></code></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class=code><div class=codehilite><pre><span></span>{% extends &#39;core/base.html&#39; %}
{% load static %}
{% block title %}Cambio de contraseña{% endblock %}
{% block content %}
<span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;.</span><span class=nc>errorlist</span><span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>red</span><span class=p>;}&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>main</span> <span class=na>role</span><span class=o>=</span><span class=s>&quot;main&quot;</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;container&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;row mt-3&quot;</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;col-md-9 mx-auto mb-5&quot;</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>method</span><span class=o>=</span><span class=s>&quot;post&quot;</span><span class=p>&gt;</span>{% csrf_token %}
            <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;mb-4&quot;</span><span class=p>&gt;</span>Cambio de contraseña<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Por favor, introduzca su contraseña antigua por seguridad, y después introduzca dos veces la nueva contraseña para verificar que la ha escrito correctamente.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
            {{form.old_password.errors}}
            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;password&quot;</span> <span class=na>name</span><span class=o>=</span><span class=s>&quot;old_password&quot;</span> <span class=na>autofocus</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>required</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>id</span><span class=o>=</span><span class=s>&quot;id_old_password&quot;</span><span class=na>class</span><span class=o>=</span><span class=s>&quot;form-control&quot;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&quot;Contraseña antigua&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
            {{form.new_password1.errors}}
            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;password&quot;</span> <span class=na>name</span><span class=o>=</span><span class=s>&quot;new_password1&quot;</span> <span class=na>required</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>id</span><span class=o>=</span><span class=s>&quot;id_new_password1&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;form-control&quot;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&quot;Contraseña nueva&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
            {{form.new_password2.errors}}
            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;password&quot;</span> <span class=na>name</span><span class=o>=</span><span class=s>&quot;new_password2&quot;</span> <span class=na>required</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>id</span><span class=o>=</span><span class=s>&quot;id_new_password2&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;form-control&quot;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&quot;Contraseña nueva (confirmación)&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;submit&quot;</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;btn btn-primary btn-block&quot;</span> <span class=na>value</span><span class=o>=</span><span class=s>&quot;Cambiar mi contraseña&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
{% endblock %}
</pre></div> </td></tr></table> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>templates</span><span class=o>/&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>password_change_done</span><span class=p>.</span><span class=n>html</span></code></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class=code><div class=codehilite><pre><span></span>{% extends &#39;core/base.html&#39; %}
{% load static %}
{% block title %}Contraseña cambiada correctamente{% endblock %}
{% block content %}
<span class=p>&lt;</span><span class=nt>main</span> <span class=na>role</span><span class=o>=</span><span class=s>&quot;main&quot;</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;container&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;row mt-3&quot;</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;col-md-9 mx-auto mb-5&quot;</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;mb-4&quot;</span><span class=p>&gt;</span>Contraseña cambiada correctamente<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Puedes volver a tu perfil haciendo clic <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{% url &#39;profile&#39; %}&quot;</span><span class=p>&gt;</span>aquí<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
{% endblock %}
</pre></div> </td></tr></table> <h3 id=optimizar-guardado-de-avatar>Optimizar guardado de avatar<a class=headerlink href=#optimizar-guardado-de-avatar title="Permanent link">&para;</a></h3> <p>Si se guardan todas las imágenes a pelo de un usuario, esto es impracticable a la larga. Lo ideal es que cuando el usuario cargue una imagen nueva, borres la anterior y la sustituyas por la nueva. Para hacer esto tienes que:</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>models</span><span class=p>.</span><span class=n>py</span></code> -&gt; En la app donde tengas la gestión del perfil, en el campo <code class=codehilite><span class=n>avatar</span></code> le pasas al argumento <code class=codehilite><span class=n>upload_to</span></code> una función, en este caso <code class=codehilite><span class=n>custom_upload_to</span></code>. A esa función tienes que pasarle primero la instancia el perfil, y luego el nombre del fichero del nuevo avatar. Una vez dentro recuperas el perfil y borras su avatar. Por último devuelves el path con el nombre donde se va a guardar la nueva imagen.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>
<span class=kn>from</span> <span class=nn>django.dispatch</span> <span class=kn>import</span> <span class=n>receiver</span>
<span class=kn>from</span> <span class=nn>django.db.models.signals</span> <span class=kn>import</span> <span class=n>post_save</span>


<span class=k>def</span> <span class=nf>custom_upload_to</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=n>filename</span><span class=p>):</span>
    <span class=n>old_instance</span> <span class=o>=</span> <span class=n>Profile</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>pk</span><span class=o>=</span><span class=n>instance</span><span class=o>.</span><span class=n>pk</span><span class=p>)</span>
    <span class=n>old_instance</span><span class=o>.</span><span class=n>avatar</span><span class=o>.</span><span class=n>delete</span><span class=p>()</span>
    <span class=k>return</span> <span class=s1>&#39;profiles/&#39;</span> <span class=o>+</span> <span class=n>filename</span>


<span class=c1># Create your models here.</span>
<span class=k>class</span> <span class=nc>Profile</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>OneToOneField</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>)</span>
    <span class=n>avatar</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ImageField</span><span class=p>(</span><span class=n>upload_to</span><span class=o>=</span><span class=n>custom_upload_to</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
                               <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bio</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>(</span><span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>link</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>URLField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>


<span class=nd>@receiver</span><span class=p>(</span><span class=n>post_save</span><span class=p>,</span> <span class=n>sender</span><span class=o>=</span><span class=n>User</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>ensure_profile_exists</span><span class=p>(</span><span class=n>sender</span><span class=p>,</span> <span class=n>instance</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;created&#39;</span><span class=p>,</span> <span class=bp>False</span><span class=p>):</span>
        <span class=n>Profile</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get_or_create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=n>instance</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Se acaba de crear un usuario y su perfil enlazado&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <h2 id=senales>Señales<a class=headerlink href=#senales title="Permanent link">&para;</a></h2> <p>Una señal es una función que se ejecuta después de que ocurra un evento. Por ejemplo, si quisieras saber cuando se ha creado un usuario correctamente, puedes hacer lo siguiente.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>models</span><span class=p>.</span><span class=n>py</span></code> -&gt; Creas la función <code class=codehilite><span class=n>ensure_profile_exists</span></code>. Importas el decorador <code class=codehilite><span class=n>receiver</span></code> y también la señal <code class=codehilite><span class=n>post_save</span></code>. Decoras la función indicándole el decorador, la señal, y quien la envía (en este caso <code class=codehilite><span class=k>User</span></code>). De los <code class=codehilite><span class=n>kwargs</span></code> compruebas si se acaba de crear el usuario y ya puedes operar con él.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>
<span class=kn>from</span> <span class=nn>django.dispatch</span> <span class=kn>import</span> <span class=n>receiver</span>
<span class=kn>from</span> <span class=nn>django.db.models.signals</span> <span class=kn>import</span> <span class=n>post_save</span>


<span class=c1># Create your models here.</span>
<span class=k>class</span> <span class=nc>Profile</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>OneToOneField</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>)</span>
    <span class=n>avatar</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ImageField</span><span class=p>(</span><span class=n>upload_to</span><span class=o>=</span><span class=s1>&#39;profiles&#39;</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bio</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>(</span><span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>link</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>URLField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>


<span class=nd>@receiver</span><span class=p>(</span><span class=n>post_save</span><span class=p>,</span> <span class=n>sender</span><span class=o>=</span><span class=n>User</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>ensure_profile_exists</span><span class=p>(</span><span class=n>sender</span><span class=p>,</span> <span class=n>instance</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;created&#39;</span><span class=p>,</span> <span class=bp>False</span><span class=p>):</span>
        <span class=n>Profile</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get_or_create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=n>instance</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Se acaba de crear un usuario y su perfil enlazado&#39;</span><span class=p>)</span>
</pre></div> </td></tr></table> <h2 id=tdd>TDD<a class=headerlink href=#tdd title="Permanent link">&para;</a></h2> <h3 id=tests-simples>Tests Simples<a class=headerlink href=#tests-simples title="Permanent link">&para;</a></h3> <p>Los tests de cada app se crean en <code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>test</span><span class=p>.</span><span class=n>py</span></code>. Un ejemplo fácil para que te quedes con la copla, sería testear el ejemplo de la señal.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>test</span><span class=p>.</span><span class=n>py</span></code> -&gt; Tienes que importar el modelo que vayas a testear, <code class=codehilite><span class=n>Profile</span></code>, y en este caso vas a necesitar de <code class=codehilite><span class=k>User</span></code> también. Creas una clase para pasar los tests de tu modelo. Con el método <code class=codehilite><span class=n>setUp</span></code> generas los datos que necesites para hacer los tests. Luego generas un método por cada test y que siga el patrón <code class=codehilite><span class=n>test_</span><span class=o>&lt;</span><span class=n>cosa_a_probar</span><span class=o>&gt;</span></code>. En este caso pruebas que se haya creado un perfil después de haber creado un usuario. En tu ejemplo obtienes el perfil que se acaba de crear por <code class=codehilite><span class=n>setUp</span></code> y lanzas un <code class=codehilite><span class=n>assert</span></code> si coincide.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.test</span> <span class=kn>import</span> <span class=n>TestCase</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Profile</span>


<span class=c1># Create your tests here.</span>
<span class=k>class</span> <span class=nc>ProfileTestCase</span><span class=p>(</span><span class=n>TestCase</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>,</span> <span class=s1>&#39;test@test.com&#39;</span><span class=p>,</span> <span class=s1>&#39;test1234&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>test_profile_exists</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>exists</span> <span class=o>=</span> <span class=n>Profile</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>user__username</span><span class=o>=</span><span class=s1>&#39;test&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>exists</span><span class=p>,</span> <span class=bp>True</span><span class=p>)</span>
</pre></div> </td></tr></table> <p>Para que se ejecuten el test debes hacer</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># Testear todo</span>
python manage.py <span class=nb>test</span>
<span class=c1># Testear la &lt;app&gt;</span>
python manage.py <span class=nb>test</span> &lt;app&gt;
<span class=c1># Testear la &lt;clase&gt; de la &lt;app&gt;</span>
python manage.py <span class=nb>test</span> &lt;app&gt;.&lt;clase&gt;
<span class=c1># Teastear el &lt;método&gt; de la &lt;clase&gt; de la &lt;app&gt;</span>
python manage.py <span class=nb>test</span> &lt;app&gt;.&lt;clase&gt;.&lt;método&gt;
</pre></div> </td></tr></table> <p>Cada vez que acaba de ejecutarse un método se borra la bbdd temporal y vuelve a ejecutarse <code class=codehilite><span class=n>setUp</span></code> y luego el siguiente método.</p> <h3 id=ejemplo-de-test-con-senales>Ejemplo de Test con señales<a class=headerlink href=#ejemplo-de-test-con-senales title="Permanent link">&para;</a></h3> <p>Suponte una app <code class=codehilite><span class=n>messenger</span></code> con dos modelos:</p> <p><code class=codehilite><span class=n>messenger</span><span class=o>/</span><span class=n>models</span><span class=p>.</span><span class=n>py</span></code> -&gt; <code class=codehilite><span class=n>Message</span></code> tiene un usuario, contenido y fecha de creacion. <code class=codehilite><span class=n>Thread</span></code> tiene usuarios, mensajes.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>


<span class=c1># Create your models here.</span>
<span class=k>class</span> <span class=nc>Message</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>)</span>
    <span class=n>content</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>()</span>
    <span class=n>created</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>DateTimeField</span><span class=p>(</span><span class=n>auto_now_add</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>

    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>ordering</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;created&#39;</span><span class=p>]</span>


<span class=k>class</span> <span class=nc>ThreadManager</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Manager</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>find</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>):</span>
        <span class=c1># self es lo mismo que Thread.objects.all()</span>
        <span class=n>queryset</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=n>user1</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=n>user2</span><span class=p>)</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>queryset</span><span class=p>):</span>
            <span class=k>return</span> <span class=n>queryset</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

    <span class=k>def</span> <span class=nf>find_or_create</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>):</span>
        <span class=n>thread</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>thread</span><span class=p>:</span>
            <span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>()</span>
            <span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>thread</span>


<span class=k>class</span> <span class=nc>Thread</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>users</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ManyToManyField</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>related_name</span><span class=o>=</span><span class=s1>&#39;threads&#39;</span><span class=p>)</span>
    <span class=n>messages</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ManyToManyField</span><span class=p>(</span><span class=n>Message</span><span class=p>)</span>
    <span class=c1># Model Manager</span>
    <span class=n>objects</span> <span class=o>=</span> <span class=n>ThreadManager</span><span class=p>()</span>
</pre></div> </td></tr></table> <p><code class=codehilite><span class=n>messenger</span><span class=o>/</span><span class=n>test</span><span class=p>.</span><span class=n>py</span></code> -&gt; Abajo tienes el código, pero fíjate en el método <code class=codehilite><span class=n>test_add_message_from_user_not_in_thread</span></code>. Quieres testear si un usuario que no está en un hilo, y el test falla.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.test</span> <span class=kn>import</span> <span class=n>TestCase</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>
<span class=kn>from</span> <span class=nn>.models</span> <span class=kn>import</span> <span class=n>Message</span><span class=p>,</span> <span class=n>Thread</span>


<span class=c1># Create your tests here.</span>
<span class=k>class</span> <span class=nc>ThreadTestCase</span><span class=p>(</span><span class=n>TestCase</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>user1</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=s1>&#39;user1&#39;</span><span class=p>,</span> <span class=bp>None</span><span class=p>,</span> <span class=s1>&#39;test1234&#39;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>user2</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=s1>&#39;user2&#39;</span><span class=p>,</span> <span class=bp>None</span><span class=p>,</span> <span class=s1>&#39;test1234&#39;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>user3</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=s1>&#39;user3&#39;</span><span class=p>,</span> <span class=bp>None</span><span class=p>,</span> <span class=s1>&#39;test1234&#39;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>()</span>

    <span class=k>def</span> <span class=nf>test_add_to_thread</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>all</span><span class=p>()),</span> <span class=mi>2</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>test_filter_thread_by_users</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=n>threads</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>)</span><span class=o>.</span>\
            <span class=nb>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=p>,</span> <span class=n>threads</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>

    <span class=k>def</span> <span class=nf>test_filter_non_existent_thread</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>threads</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>)</span><span class=o>.</span>\
            <span class=nb>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>threads</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>test_add_message_to_thread</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=n>message1</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s1>&#39;Jelou&#39;</span><span class=p>)</span>
        <span class=n>message2</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s1>&#39;Hola&#39;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>message1</span><span class=p>,</span> <span class=n>message2</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>all</span><span class=p>()),</span> <span class=mi>2</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>all</span><span class=p>():</span>
            <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s1>&#39;{message.user}: {message.content}&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>test_add_message_from_user_not_in_thread</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=n>message1</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s1>&#39;Jelou&#39;</span><span class=p>)</span>
        <span class=n>message2</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s1>&#39;Hola&#39;</span><span class=p>)</span>
        <span class=n>message3</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user3</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s1>&#39;Shurmanos&#39;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>message1</span><span class=p>,</span> <span class=n>message2</span><span class=p>,</span> <span class=n>message3</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>all</span><span class=p>()),</span> <span class=mi>2</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>test_find_thread_with_custom_manager</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=p>,</span> <span class=n>thread</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>test_find_or_create_thread_with_custom_manager</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>find_or_create</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user2</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=p>,</span> <span class=n>thread</span><span class=p>)</span>
        <span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>find_or_create</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user3</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertIsNotNone</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>thread</span><span class=p>,</span> <span class=n>thread</span><span class=p>)</span>
</pre></div> </td></tr></table> <p>Para solucionar esto, la manera de hacerlo es capturar con una señal cuando se va a introducir un mensaje a un hilo, y no hacerlo. Cuando se añade un elemento a la bbdd, saltan al menos dos eventos, <code class=codehilite><span class=n>pre_add</span></code> y <code class=codehilite><span class=n>post_add</span></code>. Te interesa captar el primero con una señal y borrar lo que no vaya a ser guardado</p> <p><code class=codehilite><span class=n>messenger</span><span class=o>/</span><span class=n>models</span><span class=p>.</span><span class=n>py</span></code> -&gt; Usa la señal <code class=codehilite><span class=n>m2m_changed</span></code> para captar cuando se va a introducir un elemento. Creas la función <code class=codehilite><span class=n>messages_changed</span></code> para manipular ese evento, con un bucle recorres todos elementos <code class=codehilite><span class=n>pk_set</span></code> y los guardas en un conjunto a parte los que no quieres <code class=codehilite><span class=n>false_pk_set</span></code> y eliminas del conjunto los elementos que no deben estar. Por último a <code class=codehilite><span class=n>m2m_changed</span></code> le conectas la función <code class=codehilite><span class=n>messages_changed</span></code> y le pones como <code class=codehilite><span class=n>sender</span></code> (emisor) el flujo/caudal de mensajes de los hilos, <code class=codehilite><span class=n>Thread</span><span class=p>.</span><span class=n>messages</span><span class=p>.</span><span class=n>through</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>
<span class=kn>from</span> <span class=nn>django.db.models.signals</span> <span class=kn>import</span> <span class=n>m2m_changed</span>


<span class=c1># Create your models here.</span>
<span class=k>class</span> <span class=nc>Message</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>)</span>
    <span class=n>content</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>()</span>
    <span class=n>created</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>DateTimeField</span><span class=p>(</span><span class=n>auto_now_add</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>

    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
        <span class=n>ordering</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;created&#39;</span><span class=p>]</span>


<span class=k>class</span> <span class=nc>ThreadManager</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Manager</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>find</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>):</span>
        <span class=c1># self es lo mismo que Thread.objects.all()</span>
        <span class=n>queryset</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=n>user1</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=n>user2</span><span class=p>)</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>queryset</span><span class=p>):</span>
            <span class=k>return</span> <span class=n>queryset</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

    <span class=k>def</span> <span class=nf>find_or_create</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>):</span>
        <span class=n>thread</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>thread</span><span class=p>:</span>
            <span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>()</span>
            <span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>thread</span>


<span class=k>class</span> <span class=nc>Thread</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>users</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ManyToManyField</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>related_name</span><span class=o>=</span><span class=s1>&#39;threads&#39;</span><span class=p>)</span>
    <span class=n>messages</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ManyToManyField</span><span class=p>(</span><span class=n>Message</span><span class=p>)</span>
    <span class=c1># Model Manager</span>
    <span class=n>objects</span> <span class=o>=</span> <span class=n>ThreadManager</span><span class=p>()</span>


<span class=k>def</span> <span class=nf>messages_changed</span><span class=p>(</span><span class=n>sender</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
    <span class=n>instance</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;instance&#39;</span><span class=p>,</span> <span class=bp>None</span><span class=p>)</span>
    <span class=n>action</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;action&#39;</span><span class=p>,</span> <span class=bp>None</span><span class=p>)</span>
    <span class=n>pk_set</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;pk_set&#39;</span><span class=p>,</span> <span class=bp>None</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s1>&#39;{instance} {action} {pk_set}&#39;</span><span class=p>)</span>
    <span class=c1># Busca los mensajes que no deben de estar en el hilo</span>
    <span class=n>false_pk_set</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
    <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s1>&#39;pre_add&#39;</span><span class=p>:</span>
        <span class=k>for</span> <span class=n>msg_pk</span> <span class=ow>in</span> <span class=n>pk_set</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>pk</span><span class=o>=</span><span class=n>msg_pk</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>msg</span><span class=o>.</span><span class=n>user</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>instance</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>all</span><span class=p>():</span>
                <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s1>&#39;{msg.user} no forma parte del hilo&#39;</span><span class=p>)</span>
                <span class=n>false_pk_set</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>msg_pk</span><span class=p>)</span>
    <span class=c1># Borra del hilo los mensajes que no deben de estar</span>
    <span class=n>pk_set</span><span class=o>.</span><span class=n>difference_update</span><span class=p>(</span><span class=n>false_pk_set</span><span class=p>)</span>


<span class=n>m2m_changed</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>messages_changed</span><span class=p>,</span> <span class=n>sender</span><span class=o>=</span><span class=n>Thread</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>through</span><span class=p>)</span>
</pre></div> </td></tr></table> <h2 id=model-manager>Model Manager<a class=headerlink href=#model-manager title="Permanent link">&para;</a></h2> <p>Para trabajar con bases de datos, Django tiene su propio ORM que llevas usando todo el rato. Cada vez que trabajas con un modelo, como con <code class=codehilite><span class=k>User</span></code>, tienes atributos y métodos ya definidos. Si quisieras extenderlos, lo que debes crear es un Model Manager.</p> <p><code class=codehilite><span class=o>&lt;</span><span class=n>app</span><span class=o>&gt;/</span><span class=n>models</span><span class=p>.</span><span class=n>py</span></code> -&gt; En el <code class=codehilite><span class=n>models</span><span class=p>.</span><span class=n>py</span></code> de tu app, debes de crear una clase que herede de</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>


<span class=k>class</span> <span class=nc>ThreadManager</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Manager</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>find</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>):</span>
        <span class=c1># self es lo mismo que Thread.objects.all()</span>
        <span class=n>queryset</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=n>user1</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>users</span><span class=o>=</span><span class=n>user2</span><span class=p>)</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>queryset</span><span class=p>):</span>
            <span class=k>return</span> <span class=n>queryset</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

    <span class=k>def</span> <span class=nf>find_or_create</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>):</span>
        <span class=n>thread</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>thread</span><span class=p>:</span>
            <span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>()</span>
            <span class=n>thread</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user1</span><span class=p>,</span> <span class=n>user2</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>thread</span>


<span class=k>class</span> <span class=nc>Thread</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>users</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ManyToManyField</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>related_name</span><span class=o>=</span><span class=s1>&#39;threads&#39;</span><span class=p>)</span>
    <span class=n>messages</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ManyToManyField</span><span class=p>(</span><span class=n>Message</span><span class=p>)</span>
    <span class=c1># Model Manager</span>
    <span class=n>objects</span> <span class=o>=</span> <span class=n>ThreadManager</span><span class=p>()</span>
</pre></div> </td></tr></table> <h2 id=js-peticiones-asincronas>JS - Peticiones asíncronas<a class=headerlink href=#js-peticiones-asincronas title="Permanent link">&para;</a></h2> <p>TODO:</p> <h2 id=deploy>Deploy<a class=headerlink href=#deploy title="Permanent link">&para;</a></h2> <p>TODO:</p> <p>recolectar los staticos con <code class=codehilite><span class=n>python</span> <span class=n>manage</span><span class=p>.</span><span class=n>py</span> <span class=n>collecstatic</span></code></p> <h2 id=customizar-el-admin>Customizar el Admin<a class=headerlink href=#customizar-el-admin title="Permanent link">&para;</a></h2> <p>TODO:</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../django-intermedio/ title=Intermedio class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Anterior </span> Intermedio </span> </div> </a> <a href=../../../../../sw/linux/linux-fecha-hora/ title="Fecha y Hora" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Siguiente </span> Fecha y Hora </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2019 Cristóbal Contreras </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../../../assets/fonts/font-awesome.css> <a href=https://github.com/crisconru class="md-footer-social__link fa fa-github"></a> <a href=https://twitter.com/crisconru class="md-footer-social__link fa fa-twitter"></a> <a href=https://linkedin.com/in/cristobalcontrerasrubio class="md-footer-social__link fa fa-linkedin"></a> </div> </div> </div> </footer> </div> <script src=../../../../../assets/javascripts/application.245445c6.js></script> <script src=../../../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../../../assets/javascripts/lunr/lunr.es.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>