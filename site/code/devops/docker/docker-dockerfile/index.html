<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Dockerfile - Tips de Cristo</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Dockerfile - Crear imagen desde cero", url: "#_top", children: [
              {title: "Estructura / Directivas del Dockerfile", url: "#estructura-directivas-del-dockerfile" },
              {title: ".dockerignore - Descartar ficheros para crear una imagen", url: "#dockerignore-descartar-ficheros-para-crear-una-imagen" },
              {title: "docker build - Construir imagen desde el Dockerfile", url: "#docker-build-construir-imagen-desde-el-dockerfile" },
              {title: "Im\u00e1genes hu\u00e9rfanas / colgadas - Dangling images", url: "#imagenes-huerfanas-colgadas-dangling-images" },
              {title: "Multi-Stage-Build", url: "#multi-stage-build" },
              {title: "Buenas pr\u00e1cticas Dockerfile", url: "#buenas-practicas-dockerfile" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../docker-volumes/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../docker-volumes/" class="btn btn-xs btn-link">
        Volumes
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../docker-comandos/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../docker-comandos/" class="btn btn-xs btn-link">
        Comandos docker
      </a>
    </div>
    
  </div>

    

    <h1 id="dockerfile-crear-imagen-desde-cero">Dockerfile - Crear imagen desde cero</h1>
<p>Info oficial -&gt; <a href="https://docs.docker.com/engine/reference/builder/">aquí</a></p>
<p>Para poder crear una imagen desde otra con todo lo que necesita, pero de manera más cómoda, lo que se usan son unos ficheros de texto llamados <code>Dockerfile</code>.</p>
<h2 id="estructura-directivas-del-dockerfile">Estructura / Directivas del Dockerfile</h2>
<p>Este fichero tiene ciertas palabras clave o directivas:</p>
<ul>
<li><code>FROM</code> -&gt; Imagen base en la que se va a basar la nueva.</li>
</ul>
<p><code>bash
  FROM &lt;image&gt; [AS &lt;name&gt;]
  FROM &lt;image&gt;[:&lt;tag&gt;] [AS &lt;name&gt;]
  FROM &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]</code></p>
<ul>
<li>Es la <strong>primera</strong> <strong>directiva</strong> del <code>Dockerfile</code>.</li>
<li>Puede haber varias <code>FROM</code> para usar lo que se llama el <strong><em>Multi-Stage-Build</em></strong>.</li>
<li>
<p>Puede ir precedida de la directiva <code>ARG</code></p>
<p>```bash
ARG  CODE_VERSION=latest
FROM base:${CODE_VERSION}
CMD  /code/run-app</p>
<p>FROM extras:${CODE_VERSION}
CMD  /code/run-extras
```</p>
</li>
<li>
<p><code>LABEL</code> -&gt; Es para añadir metadata a la imagen (autor, mantenedor, versión, etc).</p>
</li>
</ul>
<p><code>bash
  LABEL &lt;key&gt;=value&lt;value&gt;
  LABEL &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt; ...</code></p>
<ul>
<li>Puede haber más de una <code>LABEL</code> por <code>Dockerfile</code>.</li>
<li>Consiste en un conjunto de clave-valor, y pueden ir varias por línea.</li>
<li><code>MAINTAINER</code> -&gt; Creador de la imagen, pero está deprecated. Usar <code>LABEL</code>.</li>
<li><code>RUN</code> -&gt; Comandos a ejecutar ANTES de ser creada (por ejemplo, paquetes a instalarle a la imagen base).</li>
</ul>
<p><code>bash
  RUN &lt;command&gt;
  RUN ["executable", "param1", "param2"]</code></p>
<ul>
<li>Puede haber varias directivas <code>RUN</code> en un <code>Dockerfile</code>.</li>
<li>Se debe usar comillas dobles <code>"</code> no comillas simples <code>'</code>.</li>
<li><code>COPY</code> -&gt; Copia ficheros locales a la imagen.</li>
</ul>
<p><code>bash
  COPY &lt;src&gt; &lt;dest&gt;
  COPY &lt;src1&gt; &lt;src2&gt; ... &lt;dest&gt;
  COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt; ... &lt;dest&gt;
  COPY [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;", ... "&lt;dest&gt;"]</code></p>
<ul>
<li>Puede haber varios <code>COPY</code> por <code>Dockerfile</code>.</li>
<li><code>--chown</code> solo se puede usar en Linux (en Windows no).</li>
<li><code>ADD</code> -&gt; Hace lo mismo que <code>COPY</code>, pero además solo copia ficheros locales. Puedes copiar contenido desde una URL, o si el fichero está comprimido, al usar <code>ADD</code> lo descomprime.</li>
</ul>
<p><code>bash
  ADD &lt;src&gt; &lt;dest&gt;
  ADD &lt;src1&gt; &lt;src2&gt; ... &lt;dest&gt;
  ADD [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt; ... &lt;dest&gt;
  ADD [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;", ... "&lt;dest&gt;"]</code></p>
<ul>
<li>Puede haber varios <code>ADD</code> en el <code>Dockerfile</code>.</li>
<li><code>--chown</code> solo sirve en Linux (en Windows no va).</li>
<li>Se pueden usar ciertas reglas en <code>&lt;src&gt;</code> y <code>&lt;dest&gt;</code> como <code>*.py</code> (todos los ficheros que acaben en <em>.py</em>).</li>
<li><code>ENV</code> -&gt; Variable de entorno.</li>
</ul>
<p><code>bash
  ENV key value
  ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt; ...</code></p>
<ul>
<li>Puede haber varias <code>ENV</code> por <code>Dockerfile</code>.</li>
<li>Si alguna <code>ENV</code> es igual que alguna <code>ARG</code>, la sobreescribe (<code>ENV</code> &gt; <code>ARG</code>).</li>
<li><code>WORKDIR</code> -&gt; Directorio de trabajo de la imagen.</li>
</ul>
<p><code>bash
  WORKDIR &lt;path&gt;</code></p>
<ul>
<li>Puede haber varios <code>WORKDIR</code> dentro del <code>Dockerfile</code> (aunque no tiene sentido).</li>
<li>Sirve para definir el directorio con las directivas <code>RUN</code>, <code>CMD</code>, <code>ENTRYPOINT</code>, <code>COPY</code>, <code>ADD</code>.</li>
<li>
<p>Este ejemplo hace que el directorio de trabajo sea <code>/a/b/c</code></p>
<p><code>bash
WORKDIR /a
WORKDIR b
WORKDIR c</code></p>
<p>Que se podría poner de manera más simple con</p>
<p><code>bash
WORKDIR /a/b/c</code></p>
</li>
<li>
<p><code>EXPOSE</code> -&gt; Exponer por defecto un puerto del contenedor.</p>
</li>
</ul>
<p><code>bash
  EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt; ...]</code></p>
<ul>
<li>Puede haber varios <code>EXPOSE</code> por <code>Dockerfile</code>.</li>
<li>Si no se especifica el protocolo, por defecto toma <code>tcp</code>, pero si quieres <code>udp</code> tienes que especificarlo.</li>
<li>
<p>Si quisieras que permita los dos protocolos, se debe incluir en dos líneas.</p>
<p><code>bash
EXPOSE 80/tcp
EXPOSE 80/udp</code></p>
</li>
<li>
<p>Con la opción <code>-p</code> se sobreescribe lo del Dockerfile <code>docker run -p 80:80/tcp 80:80/udp ...</code>.</p>
</li>
<li>Esto se gestiona con <code>docker network</code>.</li>
<li><code>USER</code> -&gt; Sirve para indicar dentro del <code>Dockerfile</code> un usuario.</li>
</ul>
<p><code>bash
  USER &lt;user&gt;[:&lt;group&gt;]
  USER &lt;UID&gt;[:&lt;GID&gt;]</code></p>
<ul>
<li>Puede haber varios <code>USER</code> dentro del <code>Dockerfile</code>.</li>
<li>Son para ejecutar <code>RUN</code>, <code>CMD</code> o <code>ENTRYPOINT</code> con un usuario especifico, en lugar de root.</li>
<li>El usuario por defecto de un <code>Dockerfile</code> es root.</li>
<li><code>VOLUME</code> -&gt; Para persistencia de datos, indicamos al contenedor donde almacenar sus datos en un directorio del Docker Host (nuestra máquina).</li>
</ul>
<p><code>bash
  VOLUME ["/data"]</code></p>
<ul>
<li>Esto es un concepto más avanzado y se ve en su propia sección.</li>
<li>ENTRYPOINT -&gt;</li>
<li><code>CMD</code> -&gt; Acción por defecto al crear el contenedor.</li>
</ul>
<p><code>bash
  CMD ["executable", "param1", "param2"]
  CMD ["param1", "param2"]
  CMD command param1 param2</code></p>
<ul>
<li><strong>Solo</strong> puede haber <strong>una CMD por Dockerfile</strong>.</li>
</ul>
<h2 id="dockerignore-descartar-ficheros-para-crear-una-imagen">.dockerignore - Descartar ficheros para crear una imagen</h2>
<p>El <code>.dockerignore</code> equivale al <code>.gitignore</code> de git. Es un fichero donde indicarle al <code>Dockerfile</code> que archivos y/o directorios no cargar en la imagen.</p>
<h2 id="docker-build-construir-imagen-desde-el-dockerfile">docker build - Construir imagen desde el Dockerfile</h2>
<p>Por defecto el fichero se tiene que llamar <code>Dockerfile</code>, y para crear la imagen se hace</p>
<pre><code class="bash">docker build
</code></pre>

<p>Si queremos usar otro fichero con otro nombre como <code>Dockerfile</code> hay que usar la opción <code>-f</code></p>
<pre><code class="bash">docker build -f &lt;nombre-fichero-dockerfile&gt;
</code></pre>

<p>Se recomienda usar siempre la opción <code>-t</code> para asignarle un nombre y opcionalmente un tag a la imagen. Si no se especifica el tag, docker pone por defecto <code>latest</code></p>
<pre><code class="bash">docker build -t &lt;name&gt;[:&lt;tag&gt;]
</code></pre>

<p>Se le puede indicar el path donde está el <code>Dockerfile</code>, y este path puede ser incluso una url de un repo git. Se recomienda usar</p>
<pre><code class="bash">docker build -t &lt;nombre&gt;:&lt;tag&gt; &lt;path-absoluto-hasta-el-dockerfile&gt;
</code></pre>

<p>Más info:</p>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/build/">Oficial</a></li>
<li><code>docker build --help</code></li>
</ul>
<h2 id="imagenes-huerfanas-colgadas-dangling-images">Imágenes huérfanas / colgadas - Dangling images</h2>
<p>Si al construir varias imágenes del mismo <code>Dockerfile</code>, estas se llaman igual (porque no hemos especificado nombres y tags distintos), solo la más nueva tiene el nombre y todas las demás quedan huérfanas. Al usar <code>docker images</code> vemos come en su <code>REPOSITORY</code> pone <code>&lt;none&gt;</code> y en <code>TAG</code> pasa igual. Por eso <strong>HAY QUE USAR TAGS</strong>.</p>
<p>La forma de ver todas estas imágenenes colgadas es con</p>
<pre><code class="bash">docker images -f dangling=true
</code></pre>

<p>Lo lógico es borrar todas estas imágenes, para ello añadimos a la sentencia anterior <code>-q</code> para ver solo los ids y luego usar el comando <code>docker rmi</code>. Una forma automática de hacer esto es</p>
<pre><code class="bash">docker images -f dangling=true -q | xargs docker rmi
</code></pre>

<h2 id="multi-stage-build">Multi-Stage-Build</h2>
<p>Es probable que a veces necesitemos usar algo (fichero, carpetas, ...) de alguna imagen para poder usarlo en otra. Tendríamos dos opciones:</p>
<ol>
<li>Crear una imagen con "las dos imagenes dentro", es decir, crear una imagen más pesada.</li>
<li>Generar los recursos en una imagen temporal y copiarlos a la imagen final -&gt; Multi-Stage-Build.</li>
</ol>
<p>La forma de hacer el paso 2. consiste en usar varios <code>FROM</code> dentro del <code>Dockerfile</code>. A cada <code>FROM</code> se asigna un alias y para poder llamar algo de esa imagen usamos la opción <code>--from=&lt;alias&gt;</code>. El último <code>FROM</code> es con el que se va a construir la imagen, pero los anteriores los ejecuta y podemos copiar los ficheros en las instrucciones a partir del último <code>FROM</code>. Un ejemplo</p>
<pre><code class="bash">FROM &lt;imagen-que-genera-fichero&gt; AS &lt;alias-de-ayuda&gt;

# Operaciones

FROM &lt;imagen-final&gt;

COPY --from=&lt;alias-de-ayuda&gt; &lt;fichero-src-en-la-imagen-de-arriba&gt; &lt;fichero-dest-en-mi-imagen-final&gt;
</code></pre>

<p>La imagen base va a ser <code>&lt;imagen-final&gt;</code>, y todas las demás no entran dentro, pero si se generan para poder hacer el <code>COPY</code>.</p>
<h2 id="buenas-practicas-dockerfile">Buenas prácticas Dockerfile</h2>
<p>Info oficial -&gt; <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">aquí</a></p>
<ul>
<li>Contenedor efímero -&gt; Fácilmente destruible</li>
<li>Un servicio por contenedor</li>
<li>Crear un .dockerignore para evitar archivos pesados</li>
<li>Cuantas menos capas mejor:</li>
<li>Argumentos largos separados con <code>\</code>.</li>
<li>Varios argumentos en una sola capa (en vez de muchas capas).</li>
<li>No instalar paquetes innecesarios (solo el servicio).</li>
<li>Usar Multi-Stage-Build.</li>
<li>Usar <code>LABEL</code> para documentar (versiones, descripciones, etc).</li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../docker-volumes/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../docker-volumes/" class="btn btn-xs btn-link">
        Volumes
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../docker-comandos/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../docker-comandos/" class="btn btn-xs btn-link">
        Comandos docker
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>